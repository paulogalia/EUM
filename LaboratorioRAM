<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent(); ?>
  
  </head>
<body>

  <div id="splash-screen">
    <div class="spinner"></div>
    <div id="splash-text">A carregar dados de seguran√ßa<span class="loading-dots"></span></div>
  </div>

  <div class="container-lab" id="main-container" style="opacity: 0;">
    
    <div class="control-panel">
      <h4>Laborat√≥rio de Seguran√ßa</h4>
      
      <div class="control-group">
        <button class="secondary" id="btn-voltar" onclick="voltarParaConfiguracao()" style="padding: 10px 15px; font-size: 0.9em; border-width: 1px;">
          &larr;
          Voltar (Alterar Coorte)
        </button>
        <div id="voltar-loading">A voltar...</div>
      </div>

      <div class="control-group">
        <label>1.
          Filtros de Coorte:</label>
        <div id="age-slider"></div>
        <div id="age-readout" class="slider-readout">A carregar...</div>
      </div>
      
      <div class="control-group">
        <label for="filtro-gravidade">2.
          Filtro de Gravidade:</label>
        <div id="filtro-gravidade" class="checkbox-group">
          A carregar...
        </div>
      </div>

      <div class="control-group">
        <label for="filtro-causalidade">3.
          Filtro de Causalidade (Naranjo):</label>
        <div id="filtro-causalidade" class="checkbox-group">
          A carregar...
        </div>
      </div>
      
      <div class="control-group">
        <label for="control-agrupamento">4.
          Agrupar Tempo por:</label>
        <select id="control-agrupamento">
          <option value="semana">Semana</option>
          <option value="dia">Dia</option>
          <option value="mes">M√™s</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="control-tipografico">5.
          Tipo de Visualiza√ß√£o:</label>
        <select id="control-tipografico">
          <option value="bubble">Matriz de Risco (Bubble Chart)</option>
          <option value="heatmap">Incid√™ncia no Tempo (Heatmap)</option>
          <option value="treemap">Incid√™ncia Geral (Treemap)</option>
        </select>
      </div>
      
      <br>
      <button class="action" onclick="desenharGraficoRouterRAM()">üîÑ Atualizar Gr√°fico</button>

    </div>
    
    <div class="chart-container">
      <div id="graficoPlotly">
        </div>
    </div>
    
  </div>

  <div id="error-container">
    <h3>Falha ao Carregar 
      o Laborat√≥rio</h3>
    <p>Ocorreu um erro ao tentar recolher os dados do seu projeto.
      A mensagem de erro do *backend* foi:</p>
    <pre id="error-message"></pre>
    <p style="margin-top: 20px;"><b>Como resolver:</b><br>
    Verifique as suas abas `FARMACOVIGIL√ÇNCIA`, `MENU PRINCIPAL` e `Prescri√ß√£o de Doses` para nomes de colunas em falta.</p>
  </div>

  <script>
    let globalRawData;
    let infoProjeto;
    let globalAgeSlider = null; 
    let minAge = 0; 
    let maxAge = 0;
    const ONE_DAY_MS_JS = 1000 * 60 * 60 * 24;
    
    window.addEventListener('load', iniciarLaboratorioRAM);
    
    function iniciarLaboratorioRAM() {
      console.log("P√°gina 100% carregada. A pedir dados de RAM ao backend...");
      if (typeof Plotly === 'undefined' || typeof noUiSlider === 'undefined') {
        mostrarPainelDeErro("Falha ao carregar bibliotecas externas (Plotly ou noUiSlider).");
        return;
      }
      google.script.run
        .withSuccessHandler(onDadosRecebidos)
        .withFailureHandler(onErroAoReceber)
        .buscarDadosParaLaboratorioRAM();
    }
    
    function onErroAoReceber(erro) {
      console.error("Erro fatal de comunica√ß√£o:", erro);
      mostrarPainelDeErro(erro.message);
    }
    
    function onDadosRecebidos(dadosJsonString) {
      try {
        const dadosInjetados = JSON.parse(dadosJsonString);
        if (!dadosInjetados) {
          throw new Error("O backend retornou 'null'. Verifique os logs do Apps Script para erros fatais.");
        }
        if (dadosInjetados.sucesso === false) {
          throw new Error(dadosInjetados.erro);
        }
        console.log("Dados de RAM recebidos e parseados com sucesso.", dadosInjetados);
        globalRawData = dadosInjetados.rawData;
        infoProjeto = dadosInjetados.info;
        setupPainelDeControlo();
        mostrarConteudoPrincipal();
      } catch (e) {
        console.error("Erro ao processar dados:", e.message);
        mostrarPainelDeErro(e.message);
      }
    }
    
    function mostrarPainelDeErro(mensagem) {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      const error = document.getElementById('error-container');
      splash.style.opacity = '0';
      setTimeout(() => { splash.style.display = 'none'; }, 500);
      error.style.display = 'block';
      document.getElementById('error-message').textContent = mensagem;
      main.style.display = 'none';
    }
    
    function mostrarConteudoPrincipal() {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      splash.style.opacity = '0';
      setTimeout(function() {
        splash.style.display = 'none'; 
        main.style.opacity = '1';
        document.body.style.backgroundColor = 'var(--cor-fundo-app)'; 
      }, 500); 
    }
    
    function voltarParaConfiguracao() {
      const btn = document.getElementById('btn-voltar');
      const loading = document.getElementById('voltar-loading');
      btn.disabled = true;
      loading.style.display = 'block';
      const splash = document.getElementById('splash-screen');
      document.getElementById('splash-text').innerHTML = 'A voltar para a configura√ß√£o<span class="loading-dots"></span>';
      document.getElementById('main-container').style.opacity = '0';
      splash.style.display = 'flex';
      splash.style.opacity = '1';
      document.body.style.backgroundColor = 'var(--cor-fundo-card)';
      google.script.run
        .withSuccessHandler(function() {
          google.script.host.close();
        })
        .withFailureHandler(function(err) {
          btn.disabled = false;
          loading.style.display = 'none';
          mostrarPainelDeErro("Erro ao voltar: " + err.message);
        })
        .abrirModalAnaliseMedicamento(); 
    }
    
    function getUniqueValues(data, key) {
      return [...new Set(data.map(row => row[key]))]
              .filter(val => val && val !== "N/D" && val !== "N/A")
              .sort();
    }
    
    function filtrarDadosRAM() {
      const gravidadeSelecionada = Array.from(document.querySelectorAll('#filtro-gravidade input:checked')).map(cb => cb.value);
      const causalidadeSelecionada = Array.from(document.querySelectorAll('#filtro-causalidade input:checked')).map(cb => cb.value);
      const [idadeMinSelecionada, idadeMaxSelecionada] = globalAgeSlider.get();
      return globalRawData.filter(row => {
        if (!gravidadeSelecionada.includes(row.gravidade)) return false;
        if (!causalidadeSelecionada.includes(row.causalidade)) return false;
        let idadeEmDias = null;
        if (row.dataNascPacienteMs && row.dataRamMs) {
          const idadeMs = row.dataRamMs - row.dataNascPacienteMs;
          idadeEmDias = Math.floor(idadeMs / ONE_DAY_MS_JS);
        }
        if (idadeEmDias !== null && (idadeEmDias < idadeMinSelecionada || idadeEmDias > idadeMaxSelecionada)) {
          return false;
        }
        return true;
      });
    }
    
    function desenharGraficoRouterRAM() {
      if (!globalRawData) return;
      const tipoGrafico = document.getElementById('control-tipografico').value;
      if (tipoGrafico === 'bubble') {
        desenharGraficoRiscoBubble();
      } else if (tipoGrafico === 'heatmap') {
        desenharGraficoTemporalHeatmap();
      } else if (tipoGrafico === 'treemap') {
        desenharGraficoIncidenciaTreemap();
      }
    }
    
    function desenharGraficoRiscoBubble() {
      console.log("A desenhar Matriz de Risco (Bubble)...");
      const dadosFiltrados = filtrarDadosRAM();
      const contagem = {};
      dadosFiltrados.forEach(row => {
          const chave = `${row.gravidade}_${row.causalidade}`;
          contagem[chave] = (contagem[chave] || 0) + 1;
      });
      const xCausalidade = [];
      const yGravidade = [];
      const zContagem = [];
      const hoverText = [];
      const ordemGravidade = ["Leve", "Moderada", "Grave/S√©ria", "N/D"];
      const ordemCausalidade = ["Duvidosa", "Poss√≠vel", "Prov√°vel", "Definida", "N/A", "N/D"];
      Object.keys(contagem).forEach(chave => {
          const [grav, caus] = chave.split('_');
          yGravidade.push(grav);
          xCausalidade.push(caus);
          zContagem.push(contagem[chave]);
          hoverText.push(`<b>Gravidade:</b> ${grav}<br><b>Causalidade:</b> ${caus}<br><b>Contagem (N):</b> ${contagem[chave]}`);
      });
      const trace = {
        x: xCausalidade,
        y: yGravidade,
        text: hoverText,
        hoverinfo: 'text',
        mode: 'markers',
        marker: {
          size: zContagem.map(n => Math.max(n * 5, 10)), 
          color: yGravidade.map(g => {
              if (g === "Grave/S√©ria") return 'var(--cor-grave)';
              if (g === "Moderada") return 'var(--cor-moderada)';
              if (g === "Leve") return 'var(--cor-leve)';
              return 'var(--cor-nd)';
          }),
          opacity: 0.7
        }
      };
      const layout = {
        title: 'Matriz de Risco (Gravidade vs. Causalidade)',
        xaxis: { title: 'Causalidade (Naranjo)', type: 'category', categoryorder: 'array', categoryarray: ordemCausalidade },
        yaxis: { title: 'Gravidade', type: 'category', categoryorder: 'array', categoryarray: ordemGravidade },
        hovermode: 'closest',
        margin: { t: 80, b: 100, l: 150 }
      };
      Plotly.newPlot('graficoPlotly', [trace], layout);
    }
    
    function desenharGraficoTemporalHeatmap() {
      console.log("A desenhar Incid√™ncia no Tempo (Heatmap)...");
      const dadosFiltrados = filtrarDadosRAM();
      const agrupamento = document.getElementById('control-agrupamento').value;
      const contagem = {};
      const todosNomesRAM = new Set();
      const todosBuckets = new Set();
      dadosFiltrados.forEach(row => {
        let bucketId;
        if (agrupamento === "semana") bucketId = Math.floor(row.diasRelativos / 7);
        else if (agrupamento === "mes") bucketId = Math.floor(row.diasRelativos / 30.44);
        else bucketId = row.diasRelativos;
        const nomeRam = row.nomeRam;
        const chave = `${nomeRam}_${bucketId}`;
        contagem[chave] = (contagem[chave] || 0) + 1;
        todosNomesRAM.add(nomeRam);
        todosBuckets.add(bucketId);
      });
      const yLabels = Array.from(todosNomesRAM).sort();
      const xLabels = Array.from(todosBuckets).map(Number).sort((a, b) => a - b);
      const zMatrix = [];
      yLabels.forEach(ram => {
        const linha = [];
        xLabels.forEach(bucketId => {
          const chave = `${ram}_${bucketId}`;
          linha.push(contagem[chave] || 0);
        });
        zMatrix.push(linha);
      });
      const trace = {
        x: xLabels,
        y: yLabels,
        z: zMatrix,
        type: 'heatmap',
        colorscale: 'YlOrRd',
        showscale: true,
        hovertemplate: '<b>%{y}</b><br>Per√≠odo: %{x}<br>Contagem: %{z}<extra></extra>'
      };
      const layout = {
        title: `Heatmap de Incid√™ncia de RAMs vs. Tempo`,
        xaxis: { 
          title: `Per√≠odo Relativo √† Interven√ß√£o (${agrupamento})`,
          shapes: [{
              type: 'line', x0: 0, y0: -0.5, x1: 0, y1: yLabels.length - 0.5,
              line: { color: 'var(--cor-primaria)', width: 3, dash: 'dash' }
          }]
        },
        yaxis: { title: 'Rea√ß√£o Adversa (RAM)' },
        margin: { t: 80, b: 100, l: 200 }
      };
      Plotly.newPlot('graficoPlotly', [trace], layout);
    }
    
    function desenharGraficoIncidenciaTreemap() {
      console.log("A desenhar Incid√™ncia Geral (Treemap)...");
      const dadosFiltrados = filtrarDadosRAM();
      const contagemHierarquica = {};
      dadosFiltrados.forEach(row => {
        const grav = row.gravidade || "N/D";
        const ram = row.nomeRam || "N/D";
        if (!contagemHierarquica[grav]) contagemHierarquica[grav] = {};
        contagemHierarquica[grav][ram] = (contagemHierarquica[grav][ram] || 0) + 1;
      });
      const labels = ["RAMs"]; 
      const parents = [""];
      const values = [0];
      const cores = [""];
      Object.keys(contagemHierarquica).forEach(gravidade => {
        labels.push(gravidade);
        parents.push("RAMs");
        values.push(0); 
        if (gravidade === "Grave/S√©ria") cores.push('var(--cor-grave)');
        else if (gravidade === "Moderada") cores.push('var(--cor-moderada)');
        else if (gravidade === "Leve") cores.push('var(--cor-leve)');
        else cores.push('var(--cor-nd)');
        Object.keys(contagemHierarquica[gravidade]).forEach(ram => {
          labels.push(`${ram} (${gravidade})`); 
          parents.push(gravidade); 
          values.push(contagemHierarquica[gravidade][ram]); 
          cores.push(null); 
        });
      });
      const trace = {
        type: 'treemap',
        labels: labels,
        parents: parents,
        values: values,
        textinfo: 'label+value+percent-parent',
        hoverinfo: 'label+value+percent-parent',
        marker: {
          colors: cores, 
          line: { width: 1, color: '#fff'}
        }
      };
      const layout = {
        title: 'Vis√£o Geral da Incid√™ncia (Gravidade e Tipo de RAM)',
        margin: { t: 80, b: 20, l: 20, r: 20 }
      };
      Plotly.newPlot('graficoPlotly', [trace], layout);
    }
    
    
    function setupPainelDeControlo() {
      if (!globalRawData) return;
      const gravidadeContainer = document.getElementById('filtro-gravidade');
      const causalidadeContainer = document.getElementById('filtro-causalidade');
      const gravidadesUnicas = getUniqueValues(globalRawData, 'gravidade');
      const causalidadesUnicas = getUniqueValues(globalRawData, 'causalidade');
      gravidadeContainer.innerHTML = '';
      causalidadeContainer.innerHTML = '';
      gravidadesUnicas.forEach(val => {
        gravidadeContainer.innerHTML += `<label><input type="checkbox" name="gravidade" value="${val}" checked> ${val}</label>`;
      });
      causalidadesUnicas.forEach(val => {
        causalidadeContainer.innerHTML += `<label><input type="checkbox" name="causalidade" value="${val}" checked> ${val}</label>`;
      });
      const readout = document.getElementById('age-readout');
      const slider = document.getElementById('age-slider');
      const idades = globalRawData
        .map(row => {
          if (!row.dataNascPacienteMs || !row.dataRamMs) return null;
          const idadeMs = row.dataRamMs - row.dataNascPacienteMs;
          return Math.floor(idadeMs / ONE_DAY_MS_JS);
        })
        .filter(idade => idade !== null && !isNaN(idade));
      if (idades.length > 0) {
        minAge = Math.min(...idades);
        maxAge = Math.max(...idades);
        if (minAge === maxAge) maxAge += 1; 
      } else {
        minAge = 0; maxAge = 100;
      }
      globalAgeSlider = noUiSlider.create(slider, {
          start: [minAge, maxAge], 
          connect: true,
          step: 1,
          range: { 'min': minAge, 'max': maxAge },
          tooltips: [true, true], 
          format: {
            to: value => Math.round(value),
            from: value => Number(value)
          }
      });
      slider.noUiSlider.on('update', function (values) {
          readout.innerHTML = `Faixa de idade (dias): <strong>${values[0]}</strong> - <strong>${values[1]}</strong>`;
      });
      desenharGraficoRouterRAM();
    }
  </script>
</body>
</html>

// --- CONFIGURA√á√ÉO GLOBAL ---
const CONFIG = { 
  sheets: {
    prescricao: "Prescri√ß√£o de Doses",
    peso: "Registro de Peso",
    pacientes: "Pacientes",
    tabelaResumo: "MENU PRINCIPAL",
    exames: "Exames",
    examesRef: "Exames_Referencia",
    ramTab: "FARMACOVIGIL√ÇNCIA",
    dicionarioMeds: "DICION√ÅRIO_MEDICAMENTOS" // <-- FASE 1: Adicionado
  },
  headers: {
    // Aba 'Pacientes'
    nomePaciente: "PACIENTE",
    prontuario: "PRONTU√ÅRIO",
dataNascimento: "DATA_NASCIMENTO",
    gestacao: "IDADE GESTACIONAL",
    sexo: "SEXO",
    
    // Aba 'FARMACOVIGIL√ÇNCIA'
    ramTipo: "RAM",
    ramData: "DATA_RAM",
    ramGravidade: "GRAVIDADE",
    ramDesfecho: "DESFECHO",
    idEventoRam: "ID_EVENTO_RAM",
    causalidadeRam: "CAUSALIDADE_RAM",

    // Aba 'Prescri√ß√£o de Doses' (Refatorado para Fase 2)
    dataInicio: "DATA_INICIO", // Nome padr√£o que pode ser mapeado
dataFim: "DATA_FIM",
    medicamento: "MEDICAMENTO",
    codigoMedicamento: "CODIGO_MED",     // <-- FASE 2: Novo
    dosePrescrita: "DOSE_PRESCRITA",     // <-- FASE 2: Novo (ex: 5)
    unidadePrescrita: "UN_PRESCRITA",   // <-- FASE 2: Novo (ex: "ML")
    // 'doseAdministrada_mg' e 'colTaxaResultante' removidos
    
    // Aba 'Registro de Peso'
dataPeso: "DATA_AFERICAO",
    peso: "PESO_kg",

    // Aba 'Exames'
    exameData: "DATA_EXAME",
    exameNome: "NOME_EXAME",
    exameValor: "VALOR_RESULTADO",
    exameAnalise: "AN√ÅLISE",
    exameRefMin: "REF_MIN",
    exameRefMax: "REF_MAX",

    // Aba 'Exames_Referencia'
exameRefNome: "NOME_EXAME",
    exameRefTipo: "TIPO_REGRA",
    exameRefMinDias: "IDADE_MIN_DIAS",
    exameRefMaxDias: "IDADE_MAX_DIAS",
    exameRefMinValor: "VALOR_MIN",
    exameRefMaxValor: "VALOR_MAX",

    // (NOVO) Aba 'DICION√ÅRIO_MEDICAMENTOS' (Fase 1)
    dicCodigoMed: "CODIGO_MED",
    dicNomeAmigavel: "NOME_AMIGAVEL",
    dicPrincipioAtivo: "PRINCIPIO_ATIVO_ALVO",
    dicUnPrescrita: "UN_PRESCRITA",
    dicUnAlvo: "UN_ALVO_CALCULO",
    dicFatorConversao: "FATOR_CONVERSAO"
  }
};
const MASTER_DB_SHEET_ID = "1zKqYVR9seTPy3eyX5CR2xuXZtqSwwvERQn_KX3GK5JM";

// --- M√ìDULO 1: 'onEdit' ---
// (REMOVIDO CONFORME FASE 2) 

/**
 * =============================================================
 * M√ìDULO PRINCIPAL (C√≥digo.gs)
 * =============================================================
 */

/**
 * Cria o menu principal da ferramenta
 */
function onOpen(e) {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('üî¨ An√°lise EUM')
    
    // 1. O WIZARD DE SETUP INICIAL
    .addItem('üöÄ Iniciar/Configurar Novo EUM', 'abrirWizardBoasVindas')
    .addSeparator()

    // 2. O NOVO "BLOCO" DE AN√ÅLISE CENTRAL
    .addItem('üìà Iniciar An√°lise (Mapeamento Total)', 'abrirModalAnaliseMedicamento')
    .addSeparator()

    // 3. FERRAMENTAS DE PR√â-PROCESSAMENTO E LINHA
    .addSubMenu(ui.createMenu('üõ†Ô∏è Ferramentas Auxiliares')
        .addItem('üë§ Ver Perfil do Paciente', 'abrirSidebarAnalise')
        .addItem('üß™ Processar An√°lise de Exames', 'processarAnaliseExames')
        .addItem('üõ°Ô∏è Avaliar Causalidade (Naranjo)', 'abrirSidebarAvaliacao_UI')
     )
    
    // 4. (OPCIONAL) Manter relat√≥rios antigos que n√£o dependem do mapeamento
    .addSubMenu(ui.createMenu('üìä Relat√≥rios Est√°ticos (Antigos)')
        .addItem('Gerar Relat√≥rio Modular', 'abrirModalRelatorioBuilder')
     )
    .addToUi();
}

/**
 * Fun√ß√£o de lembrete
 */
function mostrarLembrete() {
  SpreadsheetApp.getUi().alert(
    'Lembretes R√°pidos da Ferramenta:',
    '1. Para usar o "Ver Prontu√°rio": Clique em qualquer linha de paciente na aba "TABELA" ou "Exames".\n\n' +
    '2. Para usar o "Avaliar Causalidade": Clique em qualquer linha de RAM na aba "FARMACOVIGIL√ÇNCIA".\n\n' +
    '3. Antes de rodar "Processar An√°lise de Exames", use o menu "Configura√ß√£o" para importar as regras e configurar a aba.',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Mostra a sidebar na interface do usu√°rio.
 */
function abrirSidebarAnalise() {
  // CORRE√á√ÉO: Usar .createTemplateFromFile().evaluate()
  const html = HtmlService.createTemplateFromFile('SidebarPaciente')
      .evaluate() // <-- CORRE√á√ÉO
      .setWidth(700)
      .setHeight(650);
  SpreadsheetApp.getUi().showModalDialog(html, 'Perfil do Paciente');
}

// --- M√ìDULO 3 & 4: PROCESSADOR EM LOTE ---
// (REMOVIDO CONFORME FASE 2) 

// --- M√ìDULO 5: OTIMIZA√á√ÉO DE PESO (CACHE) ---
// (MOVIDO PARA Utils.gs CONFORME FASE 2) 

// --- M√ìDULO 6: CONSTRUTOR DE RELAT√ìRIO MODULAR ---
// (Permanece igual)
function abrirModalRelatorioBuilder() {
  // CORRE√á√ÉO: Usar .createTemplateFromFile().evaluate()
  const html = HtmlService.createTemplateFromFile('RelatorioBuilder')
    .evaluate() // <-- CORRE√á√ÉO
    .setWidth(550)
    .setHeight(450);
  SpreadsheetApp.getUi().showModalDialog(html, 'Construtor de Relat√≥rio');
}

function gerarRelatorioModular(modulosSelecionados) {
  const ui = SpreadsheetApp.getUi();
const ss = SpreadsheetApp.getActiveSpreadsheet();
  
const nomeRelatorio = "Relat√≥rio Modular";
  let reportSheet = ss.getSheetByName(nomeRelatorio);
  if (reportSheet) {
    reportSheet.clear();
  } else {
    reportSheet = ss.insertSheet(nomeRelatorio);
}
  ss.setActiveSheet(reportSheet);
  
  reportSheet.getRange("B1").setValue("Relat√≥rio Modular Gerado em: " + new Date().toLocaleString())
      .setFontWeight("bold").setFontSize(14);
const tabelaSheet = ss.getSheetByName(CONFIG.sheets.tabelaResumo);
if (!tabelaSheet) {
    throw new Error("Aba '" + CONFIG.sheets.tabelaResumo + "' n√£o encontrada.");
}
  const tabelaRange = tabelaSheet.getDataRange();
  const tabelaData = tabelaRange.getValues();
  const tabelaHeaders = tabelaData.shift();

const idxProntuario = tabelaHeaders.indexOf(CONFIG.headers.prontuario);
  if (idxProntuario === -1) {
    throw new Error("Coluna '" + CONFIG.headers.prontuario + "' n√£o encontrada na aba 'Tabela'. O relat√≥rio n√£o pode continuar.");
}

  let currentRow = 4;
const chartWidth = 550;
  const chartHeight = 300;
  let erros = [];

  // --- M√ìDULO: Contagem por Sexo ---
  if (modulosSelecionados.includes("contagemSexo")) {
    Logger.log("Tentando gerar 'contagemSexo'...");
const idxSexo = tabelaHeaders.indexOf(CONFIG.headers.sexo);
    
    if (idxSexo === -1) {
      erros.push("M√≥dulo 'Contagem por Sexo' pulado: Coluna '" + CONFIG.headers.sexo + "' n√£o encontrada.");
} else {
      const contagem = {};
tabelaData.forEach(row => {
        const prontuario = row[idxProntuario];
        if (!prontuario) return;
        
        const sexo = row[idxSexo] || "N/D";
        contagem[sexo] = (contagem[sexo] || 0) + 1;
      });
const dadosGrafico = [["Sexo", "Contagem"]];
      Object.keys(contagem).forEach(key => dadosGrafico.push([key, contagem[key]]));

      if (dadosGrafico.length > 1) {
        currentRow = gerarGrafico_(reportSheet, "Distribui√ß√£o por Sexo", Charts.ChartType.PIE, dadosGrafico, currentRow, chartWidth, chartHeight);
}
    }
  }
  
  // --- M√ìDULO: Contagem por Prematuridade ---
  if (modulosSelecionados.includes("contagemPrematuridade")) {
     Logger.log("Tentando gerar 'contagemPrematuridade'...");
const idxGestacao = tabelaHeaders.indexOf(CONFIG.headers.gestacao); 
     
     if (idxGestacao === -1) {
       erros.push("M√≥dulo 'Contagem por Prematuridade' pulado: Coluna '" + CONFIG.headers.gestacao + "' n√£o encontrada.");
} else {
       const contagem = {};
tabelaData.forEach(row => {
         const prontuario = row[idxProntuario];
         if (!prontuario) return;
         
         const gestacaoStr = String(row[idxGestacao] || "N/D").toLowerCase();
         let classificacao = "Padr√£o/Outro";
         
if (gestacaoStr.includes("prematuro")) classificacao = "Prematuro";
         else if (gestacaoStr.includes("termo")) classificacao = "A Termo";
         
         contagem[classificacao] = (contagem[classificacao] || 0) + 1;
       });
const dadosGrafico = [["Classifica√ß√£o", "Contagem"]];
       Object.keys(contagem).forEach(key => dadosGrafico.push([key, contagem[key]]));
       
       if (dadosGrafico.length > 1) {
         currentRow = gerarGrafico_(reportSheet, "Distribui√ß√£o por Prematuridade", Charts.ChartType.PIE, dadosGrafico, currentRow, chartWidth, chartHeight);
}
     }
  }

  // --- M√ìDULO: Custo por Sexo ---
  if (modulosSelecionados.includes("custoPorSexo")) {
     Logger.log("Tentando gerar 'custoPorSexo'...");
const idxCusto = tabelaHeaders.indexOf(CONFIG.headers.custoTotal);
     const idxSexo = tabelaHeaders.indexOf(CONFIG.headers.sexo);
     
     if (idxCusto === -1 || idxSexo === -1) {
       erros.push("M√≥dulo 'Custo por Sexo' pulado: Coluna '" + CONFIG.headers.custoTotal + "' ou '" + CONFIG.headers.sexo + "' n√£o encontrada.");
} else {
       const agregador = {};
tabelaData.forEach(row => {
          const prontuario = row[idxProntuario];
          if (!prontuario) return;

          const sexo = row[idxSexo] || "N/D";
          const custo = parseFloat(String(row[idxCusto]).replace("R$", "").replace(/\./g, "").replace(",", "."));
         
 if (isNaN(custo)) return;
          
          if (!agregador[sexo]) agregador[sexo] = { soma: 0, n: 0 };
          agregador[sexo].soma += custo;
          agregador[sexo].n++;
       });
const dadosGrafico = [["Sexo", "Custo M√©dio (R$)"]];
       Object.keys(agregador).forEach(sexo => {
          const media = agregador[sexo].soma / agregador[sexo].n;
          dadosGrafico.push([sexo, media]);
       });
if (dadosGrafico.length > 1) {
         currentRow = gerarGrafico_(reportSheet, "Custo M√©dio por Sexo", Charts.ChartType.COLUMN, dadosGrafico, currentRow, chartWidth, chartHeight);
}
     }
  }
  
  // --- Finaliza√ß√£o ---
  let msgFinal = `Relat√≥rio modular gerado com ${modulosSelecionados.length} m√≥dulo(s) solicitado(s).`;
if (erros.length > 0) {
    msgFinal += "\n\nAvisos:\n" + erros.join('\n');
Logger.log("Erros/Avisos do relat√≥rio modular: " + erros.join(', '));
  }
  
  ui.alert("Sucesso!", msgFinal, ui.ButtonSet.OK);
  return "Sucesso";
}

// (A fun√ß√£o 'gerarGrafico_' foi movida para Utils.gs) 

// --- FUN√á√ÉO DE TESTE ---
// (Permanece igual)
function testarPermissaoBancoMestre() {
  try {
    Logger.log("Tentando conectar ao Banco de Dados Mestre...");
const db = SpreadsheetApp.openById(MASTER_DB_SHEET_ID);
Logger.log("Conectado com sucesso: " + db.getName());
    SpreadsheetApp.getUi().alert("Sucesso!", "Permiss√£o concedida para acessar o Banco de Dados Mestre.", SpreadsheetApp.getUi().ButtonSet.OK);
} catch (e) {
    Logger.log("Erro ao testar permiss√£o: " + e.message);
    SpreadsheetApp.getUi().alert("Erro no Teste", e.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * =============================================================
 * MÓDULO 13: ANALISADOR DE ADESÃO A PROTOCOLO
 * (v1 - Baseado em pop-up dinâmico, usa Utils.gs)
 * =============================================================
 */

/**
 * FUNÇÃO 1: Abre o pop-up "Wizard" de Análise de Protocolo.
 */
function abrirModalAnaliseProtocolo() {
  const html = HtmlService.createHtmlOutputFromFile('AnaliseProtocolo')
    .setWidth(800)  // Largura do pop-up
    .setHeight(600); // Altura do pop-up
    
  SpreadsheetApp.getUi().showModalDialog(html, 'Analisador de Adesão ao Protocolo');
}


/**
 * FUNÇÃO 2 (PRINCIPAL): Executa a análise de adesão.
 * Chamada pelo pop-up 'AnaliseProtocolo.html'
 */
function gerarAnaliseAdesao(opcoes) {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  Logger.log(`Iniciando 'gerarAnaliseAdesao' para ${opcoes.medicamento}`);
  
  try {
    // --- 1. Ler Mapas e Dados ---
    const patientMap = buildPatientMap_(); // Do Utils.gs
    
    const prescricaoSheet = ss.getSheetByName(CONFIG.sheets.prescricao);
    if (!prescricaoSheet) throw new Error("Aba '" + CONFIG.sheets.prescricao + "' não encontrada.");
    
    const prescricaoData = prescricaoSheet.getDataRange().getValues();
    const hPresc = prescricaoData.shift();
    const idxPront = hPresc.indexOf(CONFIG.headers.prontuario);
    const idxMed = hPresc.indexOf(CONFIG.headers.medicamento);
    const idxTaxa = hPresc.indexOf(CONFIG.headers.colTaxaResultante); // <-- LÊ A TAXA JÁ CALCULADA

    if (idxPront === -1 || idxMed === -1 || idxTaxa === -1) {
      throw new Error(`Aba '${CONFIG.sheets.prescricao}' precisa das colunas: '${CONFIG.headers.prontuario}', '${CONFIG.headers.medicamento}' e '${CONFIG.headers.colTaxaResultante}'.`);
    }

    // --- 2. Encontrar Pacientes-Alvo (Baseado nos Filtros) ---
    const prontuariosFiltrados = Object.keys(patientMap).filter(prontuario => {
      const patient = patientMap[prontuario];
      
      // Filtro de Sexo
      if (opcoes.filtros.sexo !== 'todos' && patient.sexo !== opcoes.filtros.sexo) {
        return false;
      }
      
      // Filtro de CID (ainda não implementado, mas aqui ficaria)
      // if (opcoes.filtros.cid && patient.cid !== opcoes.filtros.cid) {
      //   return false;
      // }
      
      return true;
    });
    
    Logger.log(`${prontuariosFiltrados.length} pacientes encontrados após filtros.`);

    // --- 3. Analisar Cada Prescrição ---
    // Estrutura: { "Protocolo 1": { Dentro: 0, Acima: 0, Abaixo: 0, Desvios: [] }, ... }
    const resultados = {};
    opcoes.protocolos.forEach(p => {
      resultados[p.nome] = { Dentro: 0, Acima: 0, Abaixo: 0, Desvios: [] };
    });

    prescricaoData.forEach(row => {
      const prontuario = String(row[idxPront] || "").trim();
      const medicamento = row[idxMed];
      const taxa = parseFloat(row[idxTaxa]);
      
      // Verifica se a dose é relevante (Paciente filtrado, Medicamento correto, Taxa válida)
      if (prontuariosFiltrados.includes(prontuario) &&
          medicamento === opcoes.medicamento &&
          !isNaN(taxa)) {
        
        // Compara com CADA protocolo que o usuário criou
        opcoes.protocolos.forEach(protocolo => {
          if (taxa < protocolo.min) {
            resultados[protocolo.nome].Abaixo++;
            // Guarda a linha do desvio
            resultados[protocolo.nome].Desvios.push([
              prontuario,
              patientMap[prontuario].nome, // Pega o nome do mapa
              taxa.toFixed(2),
              "Abaixo"
            ]);
          } else if (taxa > protocolo.max) {
            resultados[protocolo.nome].Acima++;
            resultados[protocolo.nome].Desvios.push([
              prontuario,
              patientMap[prontuario].nome,
              taxa.toFixed(2),
              "Acima"
            ]);
          } else {
            resultados[protocolo.nome].Dentro++;
          }
        });
      }
    });

    // --- 4. Gerar a Aba de Relatório ---
    const nomeRelatorio = `Adesão - ${opcoes.medicamento.substring(0, 20)}`;
    let reportSheet = ss.getSheetByName(nomeRelatorio);
    if (reportSheet) reportSheet.clear();
    else reportSheet = ss.insertSheet(nomeRelatorio);
    ss.setActiveSheet(reportSheet);

    reportSheet.getRange("B1").setValue(`Relatório de Adesão ao Protocolo: ${opcoes.medicamento}`)
      .setFontWeight("bold").setFontSize(16);
    
    let currentRow = 4;
    
    // Loop para cada protocolo
    opcoes.protocolos.forEach(protocolo => {
      const nome = protocolo.nome;
      const res = resultados[nome];
      const total = res.Dentro + res.Acima + res.Abaixo;
      
      if (total === 0) {
        reportSheet.getRange(currentRow, 2).setValue(`Protocolo: ${nome} (Min: ${protocolo.min}, Max: ${protocolo.max})`)
          .setFontWeight("bold").setFontSize(14).setBackground("#eeeeee");
        currentRow++;
        reportSheet.getRange(currentRow, 2).setValue("Nenhuma dose encontrada para este protocolo e filtros.");
        currentRow += 2;
        return; // Pula para o próximo protocolo
      }
      
      // Título da Secção
      reportSheet.getRange(currentRow, 2).setValue(`Protocolo: ${nome} (Min: ${protocolo.min}, Max: ${protocolo.max})`)
        .setFontWeight("bold").setFontSize(14).setBackground("#eeeeee");
      currentRow++;
      
      // Tabela do Gráfico de Pizza
      const dadosGrafico = [
        ["Categoria", "Contagem"],
        ["Dentro do Protocolo", res.Dentro],
        ["Acima do Protocolo", res.Acima],
        ["Abaixo do Protocolo", res.Abaixo]
      ];
      
      // Gera o Gráfico de Pizza (usando o helper do Utils.gs)
      currentRow = gerarGrafico_(reportSheet, `Adesão: ${nome}`, Charts.ChartType.PIE, dadosGrafico, currentRow, 550, 350);
      
      // Gera a Tabela de Desvios
      if (res.Desvios.length > 0) {
        reportSheet.getRange(currentRow, 2).setValue("Registos Fora do Protocolo:");
        currentRow++;
        const headersDesvio = ["Prontuário", "Paciente", "Taxa (mg/kg)", "Status"];
        const rangeDesvio = reportSheet.getRange(currentRow, 2, res.Desvios.length + 1, headersDesvio.length);
        
        rangeDesvio.setValues([headersDesvio, ...res.Desvios]);
        
        // Formata a tabela de desvios
        rangeDesvio.setBorder(true, true, true, true, true, true);
        reportSheet.getRange(currentRow, 2, 1, headersDesvio.length).setFontWeight("bold").setBackground("#fff2cc");
        
        // Pinta as linhas de "Acima" e "Abaixo" de vermelho
        for (let i = 0; i < res.Desvios.length; i++) {
          if (res.Desvios[i][3] === "Acima" || res.Desvios[i][3] === "Abaixo") {
            reportSheet.getRange(currentRow + 1 + i, 2, 1, headersDesvio.length).setBackground("#f4cccc"); // Vermelho claro
          }
        }
        
        currentRow += res.Desvios.length + 2; // Pula para a próxima secção
      } else {
        reportSheet.getRange(currentRow, 2).setValue("100% de Adesão: Nenhum desvio encontrado.");
        currentRow += 2;
      }
    });
    
    ui.alert("Sucesso!", `O Relatório de Adesão '${nomeRelatorio}' foi criado.`, ui.ButtonSet.OK);
    
  } catch (e) {
    Logger.log("ERRO FATAL em gerarAnaliseAdesao: " + e.message + "\nStack: " + e.stack);
    ui.alert("Erro no Script", "Ocorreu um erro: " + e.message, ui.ButtonSet.OK);
    throw e;
  }
}
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  
  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent(); ?>
  
  <style>
    body {
      padding: 32px;
    }
    
    h3 {
      /* Cor verde específica para o Setup */
      color: #00573D;
    }
    
    p {
      font-size: 1.1em;
      text-align: center;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--cor-borda);
    }
    
    .block {
      margin-bottom: 24px;
    }
    
    .label {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--cor-texto-titulo);
      margin-bottom: 12px;
      display: block;
    }

    /* Layouts de Grelha */
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    
    /* Inputs de Custo */
    .cost-input-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .cost-input-group label {
      font-weight: bold;
      margin-right: 10px;
      min-width: 100px;
    }
    
    button.action {
      float: right;
    }
  </style>
</head>
<body>
  
  <div class="container" style="padding: 0;"> <div class="header">
      <h3>Wizard de Análise de Custo-Efetividade</h3>
      <p>Simule custos e compare a eficácia e segurança entre grupos.</p>
    </div>

    <div class="block">
      <label class="label">Passo 1: Selecionar a Fonte de Dados</label>
      <div class="grid-3">
        <div>
          <label for="select-aba" style="font-size:0.9em; font-weight:bold;">Aba de Prescrição:</label>
          <select id="select-aba" onchange="carregarColunas()">
            <option value="" disabled selected>Carregando abas...</option>
          </select>
        </div>
        <div>
          <label for="select-coluna" style="font-size:0.9em; font-weight:bold;">Coluna de Agrupamento:</label>
          <select id="select-coluna" onchange="carregarGrupos()">
            <option value="" disabled selected>Aguardando aba...</option>
          </select>
        </div>
        <div>
          <label for="select-medicamento" style="font-size:0.9em; font-weight:bold;">Medicamento-Alvo:</label>
          <select id="select-medicamento">
            <option value="" disabled selected>Aguardando aba...</option>
          </select>
        </div>
      </div>
    </div>

    <div class="block">
      <label class="label">Passo 2: Informar os Custos (Simulação)</label>
      <div id="cost-input-container">
        <p style="text-align: left; padding: 0;"><i>Por favor, selecione uma aba e coluna de agrupamento primeiro.</i></p>
      </div>
    </div>
    
    <div class="block">
      <div class="grid-2">
        <div>
          <label class="label">Passo 3: Definir "Sucesso" (Eficácia)</label>
          <label for="select-exame" style="font-size:0.9em; font-weight:bold;">Onde Exame:</label>
          <select id="select-exame">
            <option value="">-- Nenhum --</option>
            <option value="Cálcio Total">Cálcio Total</option>
            <option value="Fósforo">Fósforo</option>
            <option value="Fosfatase Alcalina">Fosfatase Alcalina</option>
            <option value="Ureia">Ureia</option>
            <option value="Creatinina">Creatinina</option>
          </select>
          <label for="select-analise" style="margin-top: 10px; font-size:0.9em; font-weight:bold;">Tem Análise:</label>
          <select id="select-analise">
            <option value="">-- Qualquer --</option>
            <option value="Normal">Normal</option>
            <option value="Abaixo">Abaixo</option>
            <option value="Acima">Acima</option>
          </select>
        </div>
        <div>
          <label class="label">Passo 4: Definir "Risco" (Segurança)</label>
          <label for="select-ram" style="font-size:0.9em; font-weight:bold;">Onde RAM é:</label>
          <select id="select-ram">
            <option value="qualquer">Qualquer RAM</option>
            <option value="Grave/Séria">Apenas Grave/Séria</option>
            <option value="">-- Nenhuma (Ignorar) --</option>
          </select>
        </div>
      </div>
    </div>

    <div class="block">
      <button class="action" onclick="iniciarAnalise()">Gerar Relatório Custo-Efetividade</button>
      <div id="loading"><p>Analisando... Isso pode levar alguns segundos. Por favor, aguarde.</p></div>
      <div id="error"></div>
    </div>
    
  </div>

  <script>
    window.addEventListener('load', function() {
      // (JS para carregar abas e medicamentos)
      const abas = ["Prescrição de Doses", "Prescricao_CE"]; 
      popularDropdownAba(abas);
      google.script.run
        .withSuccessHandler(popularDropdownMedicamentos)
        .withFailureHandler(mostrarErro)
        .obterListaDeMedicamentosUnicos(); 
    });
    
    function popularDropdownAba(abas) {
      const select = document.getElementById('select-aba');
      select.innerHTML = '<option value="" disabled selected>-- Selecione uma aba --</option>';
      abas.forEach(aba => {
        if (aba === "Prescricao_CE") {
          select.innerHTML += `<option value="${aba}" selected>${aba}</option>`; 
        } else {
          select.innerHTML += `<option value="${aba}">${aba}</option>`;
        }
      });
      carregarColunas();
    }
    
    function popularDropdownMedicamentos(medicamentos) {
      const select = document.getElementById('select-medicamento');
      select.innerHTML = '<option value="" selected>-- Todos os Medicamentos --</option>';
      medicamentos.forEach(med => {
        select.innerHTML += `<option value="${med}">${med}</option>`;
      });
    }

    function carregarColunas() {
      const nomeAba = document.getElementById('select-aba').value;
      if (!nomeAba) return;
      google.script.run
        .withSuccessHandler(popularDropdownColunas)
        .withFailureHandler(mostrarErro)
        .obterColunasDaAba(nomeAba); 
    }

    function popularDropdownColunas(colunas) {
      const select = document.getElementById('select-coluna');
      select.innerHTML = '<option value="" disabled selected>-- Selecione uma coluna --</option>';
      colunas.forEach(col => {
        if (col === "FABRICANTE") {
          select.innerHTML += `<option value="${col}" selected>${col}</option>`;
        } else {
          select.innerHTML += `<option value="${col}">${col}</option>`;
        }
      });
      carregarGrupos();
    }
    
    function carregarGrupos() {
      const nomeAba = document.getElementById('select-aba').value;
      const nomeColuna = document.getElementById('select-coluna').value;
      if (!nomeAba || !nomeColuna) return;
      
      const container = document.getElementById('cost-input-container');
      container.innerHTML = '<p style="text-align: left; padding: 0;"><i>Carregando grupos da coluna ' + nomeColuna + '...</i></p>';
      
      google.script.run
        .withSuccessHandler(popularCaixasDeCusto)
        .withFailureHandler(mostrarErro)
        .obterGruposDeComparacao(nomeAba, nomeColuna); 
    }
    
    function popularCaixasDeCusto(grupos) {
      const container = document.getElementById('cost-input-container');
      container.innerHTML = '';
      if (grupos.length === 0) {
        container.innerHTML = '<p style="text-align: left; padding: 0;"><i>Nenhum grupo encontrado.</i></p>';
        return;
      }
      container.innerHTML += '<p stylei="font-size: 0.9em; margin-bottom: 10px; text-align: left; padding: 0;">Informe o custo simulado (por dia) para cada grupo:</p>';
      grupos.forEach(grupo => {
        container.innerHTML += `
          <div class="cost-input-group">
            <label for="custo-${grupo}">${grupo}:</label>
            <input type="number" id="custo-${grupo}" class="custo-input" placeholder="R$ por Dia de Tratamento">
          </div>
        `;
      });
    }

    function iniciarAnalise() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';

      const custos = {};
      const inputsCusto = document.querySelectorAll('.custo-input');
      inputsCusto.forEach(input => {
        const grupo = input.id.replace('custo-', '');
        const custo = parseFloat(input.value);
        if (!isNaN(custo)) {
          custos[grupo] = custo;
        }
      });

      if (Object.keys(custos).length === 0) {
        mostrarErro({ message: "Por favor, informe pelo menos um custo." }); return;
      }
      
      const opcoes = {
        abaPrescricao: document.getElementById('select-aba').value,
        colunaAgrupadora: document.getElementById('select-coluna').value,
        medicamentoAlvo: document.getElementById('select-medicamento').value,
        custosSimulados: custos,
        eficacia: {
          exame: document.getElementById('select-exame').value,
          analise: document.getElementById('select-analise').value
        },
        risco: {
          gravidade: document.getElementById('select-ram').value
        }
      };

      google.script.run
        .withSuccessHandler(analiseCompleta)
        .withFailureHandler(mostrarErro)
        .gerarAnaliseCustoEfetividade(opcoes); 
    }

    function analiseCompleta(mensagem) {
      document.getElementById('loading').style.display = 'none';
      google.script.host.close();
    }

    function mostrarErro(erro) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Erro: ' + erro.message;
    }
  </script>
</body>
</html>

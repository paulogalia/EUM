/**
 * =============================================================
 * MÓDULO DE UTILITÁRIOS (Utils.gs) - A "Caixa de Ferramentas" Central
 * =============================================================
 */

/**
 * HELPER 1: Constrói o mapa de dados dos pacientes da 'TABELA'.
 */
function buildPatientMap_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const tabelaSheet = ss.getSheetByName(CONFIG.sheets.tabelaResumo);
  if (!tabelaSheet) throw new Error("Aba '" + CONFIG.sheets.tabelaResumo + "' não encontrada.");
  const data = tabelaSheet.getDataRange().getValues();
  const headers = data.shift(); 
  const idx = {
    prontuario: headers.indexOf(CONFIG.headers.prontuario),
    nome: headers.indexOf(CONFIG.headers.nomePaciente), 
    dataNasc: headers.indexOf(CONFIG.headers.dataNascimento),
    gestacao: headers.indexOf(CONFIG.headers.gestacao),
    sexo: headers.indexOf(CONFIG.headers.sexo)
  };
  if (idx.prontuario === -1 || idx.dataNasc === -1 || idx.sexo === -1 || idx.nome === -1) {
    throw new Error(`A aba '${CONFIG.sheets.tabelaResumo}' deve conter todas estas colunas (verifique o CONFIG): '${CONFIG.headers.prontuario}', '${CONFIG.headers.dataNascimento}', '${CONFIG.headers.sexo}' e '${CONFIG.headers.nomePaciente}'.`);
  }
  const gestacaoColumnExists = idx.gestacao !== -1;
  const map = {};
  data.forEach(row => {
    const prontuario = String(row[idx.prontuario]).trim();
    if (!prontuario) return;
    let dataNasc = null;
    try {
      const dataVal = row[idx.dataNasc];
      if (dataVal) dataNasc = new Date(dataVal);
    } catch (e) {}
    let sexo = String(row[idx.sexo] || "").toUpperCase().charAt(0);
    if (sexo !== "M" && sexo !== "F") sexo = null; 
    let nome = row[idx.nome] || "Sem Nome";
    let éPrematuro = false;
    let semanasGestao = 40; 
    if (gestacaoColumnExists) {
      const gestacaoStr = String(row[idx.gestacao] || "").toLowerCase();
      if (gestacaoStr.includes("prematuro")) {
        éPrematuro = true;
        const match = gestacaoStr.match(/(\d+)\s*sem(ana|anas)?/);
        if (match) semanasGestao = parseInt(match[1], 10);
        else éPrematuro = false;
      }
    }
    map[prontuario] = {
      nome: nome, dataNasc: dataNasc, éPrematuro: éPrematuro,
      semanasGestao: semanasGestao, sexo: sexo
    };
  });
  return map;
}

/**
 * HELPER 2: Calcula a média E o Desvio Padrão.
 */
function calcularEstatisticas_(arr) {
  if (!arr || arr.length === 0) {
    return { media: null, n: 0, stdDev: null };
  }
  const n = arr.length;
  const sum = arr.reduce((a, b) => a + b, 0);
  const media = sum / n;
  if (n === 1) {
    return { media: media, n: 1, stdDev: 0 }; 
  }
  const variancia = arr.map(x => Math.pow(x - media, 2)).reduce((a, b) => a + b, 0) / (n - 1);
  const stdDev = Math.sqrt(variancia);
  return { media: media, n: n, stdDev: stdDev };
}

/**
 * HELPER 3: Calcula apenas a média (atalho).
 */
function calcularMedia_(arr) {
  const stats = calcularEstatisticas_(arr);
  return stats.media;
}


/**
 * HELPER 4: Função genérica para criar e inserir um gráfico do Sheets.
 */
function gerarGrafico_(sheet, titulo, tipo, dados, linha, largura, altura, stacked = false) {
  try {
    sheet.getRange(linha, 2).setValue(titulo).setFontWeight("bold").setFontSize(12);
    linha++;
    const dataRange = sheet.getRange(linha, 2, dados.length, dados[0].length);
    dataRange.setValues(dados);
    const chartBuilder = sheet.newChart()
      .setChartType(tipo)
      .addRange(dataRange)
      .setOption('title', titulo)
      .setOption('width', largura)
      .setOption('height', altura)
      .setPosition(linha, 4, 0, 0); 
    if (tipo === Charts.ChartType.PIE) {
      chartBuilder.setOption('pieHole', 0.4);
    }
    if (tipo === Charts.ChartType.COLUMN && stacked) {
      chartBuilder.setOption('isStacked', true);
    }
    sheet.insertChart(chartBuilder.build());
    const approxChartRows = Math.ceil(altura / 21) + 1; 
    return linha + Math.max(approxChartRows, dados.length) + 2; 
  } catch (e) {
    Logger.log("Erro ao gerar gráfico '" + titulo + "': " + e.message);
    sheet.getRange(linha, 2).setValue("Erro ao gerar gráfico: " + e.message);
    return linha + 3; 
  }
}

/**
 * HELPER 5: Pega a lista de medicamentos para os pop-ups.
 */
function obterListaDeMedicamentosUnicos() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CONFIG.sheets.prescricao);
    if (!sheet) throw new Error("Aba '" + CONFIG.sheets.prescricao + "' não encontrada.");
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const idxMed = headers.indexOf(CONFIG.headers.medicamento);
    if (idxMed === -1) {
      throw new Error("Coluna '" + CONFIG.headers.medicamento + "' não encontrada.");
    }
    const data = sheet.getRange(2, idxMed + 1, sheet.getLastRow() - 1, 1).getValues();
    const unicos = [...new Set(data.map(row => row[0]))].filter(med => med); 
    return unicos;
  } catch (e) {
    Logger.log("Erro em obterListaDeMedicamentosUnicos: " + e.message);
    throw e;
  }
}

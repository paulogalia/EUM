<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  
  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent(); ?>
  
  <style>
    body {
      /* O fundo do modal é o cinza da app */
      background-color: var(--cor-fundo-app);
      padding: 32px; /* Dá espaço para o card respirar */
    }
    
    /* O .card principal conterá TUDO */
    .card {
      padding: 24px 32px;
      max-width: 600px; /* Limita a largura do formulário */
      margin: 0 auto; /* Centraliza o card */
    }
    
    /* O cabeçalho do Naranjo, AGORA DENTRO do card */
    .naranjo-header {
      border-bottom: 1px solid var(--cor-borda);
      margin-bottom: 24px;
      padding-bottom: 20px;
    }
    .naranjo-header h3 {
      text-align: left; /* Alinha o título "Algoritmo de Naranjo" à esquerda */
      margin-top: 0;
    }
    .naranjo-header p {
      font-size: 1.1em;
      margin: 4px 0 0 0;
      color: var(--cor-texto-corpo);
      text-align: left; /* Alinha os dados do paciente à esquerda */
      border: none; /* Remove a borda que o 'p' genérico tinha */
      padding: 0;
    }
    .naranjo-header strong {
      color: var(--cor-texto-titulo);
    }
    
    /* O botão de salvar fica no final do card */
    .card .action {
      float: none; /* Garante que o botão ocupe a largura toda */
      margin-top: 20px;
    }
  </style>
</head>
<body>
  
  <div id="splash-screen">
    <div class="spinner"></div>
    <div id="splash-text">A carregar dados...</div>
  </div>

  <div id="error-container">
    <h3>Falha ao Carregar</h3>
    <pre id="error-message"></pre>
  </div>

  <div class="card" id="main-content" style="display: none;">

    <div class="naranjo-header">
      <h3>Algoritmo de Naranjo</h3>
      <p>Paciente: <strong id="paciente-prontuario">...</strong></p>
      <p>Medicamento: <strong id="paciente-medicamento">...</strong></p>
      <p>Reação: <strong id="paciente-ram">...</strong></p>
    </div>
    
    <form id="naranjo-form">
      <input type="hidden" id="id-evento-ram" name="idEventoRam">

      <div class="form-group">
        <label>1. Existem relatos conclusivos sobre essa reação?</label>
        <select id="q1" name="q1">
          <option value="0">Não Sabe (0)</option>
          <option value="1">Sim (+1)</option>
          <option value="0">Não (0)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>2. O evento clínico apareceu após a admin. do fármaco?</label>
        <select id="q2" name="q2">
          <option value="0">Não Sabe (0)</option>
          <option value="2">Sim (+2)</option>
          <option value="-1">Não (-1)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>3. A reação desapareceu com a descontinuação?</label>
        <select id="q3" name="q3">
          <option value="0">Não Sabe (0)</option>
          <option value="1">Sim (+1)</option>
          <option value="0">Não (0)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>4. A reação reapareceu com a readministração?</label>
        <select id="q4" name="q4">
          <option value="0">Não Sabe (0)</option>
          <option value="2">Sim (+2)</option>
          <option value="-1">Não (-1)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>5. Existem causas alternativas?</label>
        <select id="q5" name="q5">
          <option value="0">Não Sabe (0)</option>
          <option value="-1">Sim (-1)</option>
          <option value="2">Não (+2)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>6. A reação apareceu com placebo?</label>
        <select id="q6" name="q6">
          <option value="0">Não Sabe (0)</option>
          <option value="-1">Sim (-1)</option>
          <option value="1">Não (+1)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>7. Fármaco detectado em concentração tóxica?</label>
        <select id="q7" name="q7">
          <option value="0">Não Sabe (0)</option>
          <option value="1">Sim (+1)</option>
          <option value="0">Não (0)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>8. Reação aumentou com dose maior / diminuiu com dose menor?</label>
        <select id="q8" name="q8">
          <option value="0">Não Sabe (0)</option>
          <option value="1">Sim (+1)</option>
          <option value="0">Não (0)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>9. Paciente teve reação prévia similar (mesmo fármaco/similar)?</label>
        <select id="q9" name="q9">
          <option value="0">Não Sabe (0)</option>
          <option value="1">Sim (+1)</option>
          <option value="0">Não (0)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>10. Reação confirmada por evidência objetiva?</label>
        <select id="q10" name="q10">
          <option value="0">Não Sabe (0)</option>
          <option value="1">Sim (+1)</option>
          <option value="0">Não (0)</option>
        </select>
      </div>

      <button type="button" class="action" id="btn-salvar" onclick="salvarFormulario()">Salvar Avaliação</button>
      <div id="loading" style="text-align: center; padding-top: 10px;">Salvando...</div>
    </form>
    
  </div> <script>
    const splash = document.getElementById('splash-screen');
    const main = document.getElementById('main-content');
    const error = document.getElementById('error-container');
    const btnSalvar = document.getElementById('btn-salvar');
    const loadingSalvar = document.getElementById('loading');

    window.addEventListener('load', function() {
      main.style.display = 'none';
      error.style.display = 'none';
      splash.style.display = 'flex';
      
      google.script.run
        .withSuccessHandler(preencherFormulario)
        .withFailureHandler(mostrarErro)
        .obterDadosParaAvaliacao();
    });

    function preencherFormulario(dados) {
      if (dados.error) {
        mostrarErro(dados);
        return;
      }
      
      splash.style.display = 'none';
      main.style.display = 'block';

      document.getElementById('paciente-prontuario').textContent = dados.prontuario;
      document.getElementById('paciente-medicamento').textContent = dados.medicamentoSuspeito;
      document.getElementById('paciente-ram').textContent = dados.ramDescrita;
      document.getElementById('id-evento-ram').value = dados.idEventoRam;
      
      if (dados.dadosSalvos) {
        document.getElementById('q1').value = dados.dadosSalvos.Q1_PREVIA || "0";
        document.getElementById('q2').value = dados.dadosSalvos.Q2_TEMPO || "0";
        document.getElementById('q3').value = dados.dadosSalvos.Q3_SUSPENSAO || "0";
        document.getElementById('q4').value = dados.dadosSalvos.Q4_REINTRODUCAO || "0";
        document.getElementById('q5').value = dados.dadosSalvos.Q5_CAUSAS_ALTERNATIVAS || "0";
        document.getElementById('q6').value = dados.dadosSalvos.Q6_PLACEBO || "0";
        document.getElementById('q7').value = dados.dadosSalvos.Q7_NIVEL_TOXICO || "0";
        document.getElementById('q8').value = dados.dadosSalvos.Q8_DOSE || "0";
        document.getElementById('q9').value = dados.dadosSalvos.Q9_HISTORIA_PREVIA || "0";
        document.getElementById('q10').value = dados.dadosSalvos.Q10_CONFIRMACAO_OBJETIVA || "0";
      }
    }

    function salvarFormulario() {
      btnSalvar.disabled = true;
      btnSalvar.textContent = "A Salvar...";
      loadingSalvar.style.display = 'block';

      const dadosParaSalvar = {
        ID_EVENTO_RAM: document.getElementById('id-evento-ram').value,
        MEDICAMENTO_SUSPEITO: document.getElementById('paciente-medicamento').textContent,
        RAM_DESCRITA: document.getElementById('paciente-ram').textContent,
        
        Q1_PREVIA: document.getElementById('q1').value,
        Q2_TEMPO: document.getElementById('q2').value,
        Q3_SUSPENSAO: document.getElementById('q3').value,
        Q4_REINTRODUCAO: document.getElementById('q4').value,
        Q5_CAUSAS_ALTERNATIVAS: document.getElementById('q5').value,
        Q6_PLACEBO: document.getElementById('q6').value,
        Q7_NIVEL_TOXICO: document.getElementById('q7').value,
        Q8_DOSE: document.getElementById('q8').value,
        Q9_HISTORIA_PREVIA: document.getElementById('q9').value,
        Q10_CONFIRMACAO_OBJETIVA: document.getElementById('q10').value
      };
      
      google.script.run
        .withSuccessHandler(salvoComSucesso)
        .withFailureHandler(mostrarErro)
        .salvarAvaliacaoNaranjo(dadosParaSalvar);
    }
    
    function salvoComSucesso(resultado) {
      btnSalvar.textContent = "Salvo com Sucesso!";
      loadingSalvar.style.display = 'none';
      
      setTimeout(function() {
        google.script.host.close();
      }, 1500);
    }

    function mostrarErro(erro) {
      splash.style.display = 'none';
      main.style.display = 'none';
      error.style.display = 'block';
      document.getElementById('error-message').textContent = erro.message;
    }
  </script>
</body>
</html>

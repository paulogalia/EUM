<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent();
?>
  
  <style>
    .container-lab {
      display: grid;
      grid-template-columns: 320px 1fr; /* Painel de Controlo + Gr√°fico */
      grid-template-rows: 1fr;
      height: 100vh;
    }
    
    .control-group select {
      padding: 12px;
      font-size: 1em;
    }

    .button-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    button.action-afixar {
      font-size: 1em; 
      font-weight: bold;
      background-color: #fff;
      border: 2px solid #00573D; /* Verde escuro */
      color: #00573D;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      box-sizing: border-box;
    }
    button.action-afixar:hover {
      background-color: #f0f5f3;
    }
    button.action-afixar:disabled {
      background-color: #eee;
      border-color: #aaa;
      color: #aaa;
      cursor: not-allowed;
    }
    #afixar-loading {
      display: none;
      text-align: center;
      font-size: 0.9em;
      margin-top: 8px;
    }
    
    /* === MUDAN√áA 2: Estilos para o Modal de Contexto === */
    .modal-overlay {
      display: none; /* Come√ßa escondido */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 100;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background-color: var(--cor-fundo-app); /* Fundo cinza */
      width: 90%;
      max-width: 700px;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cor-borda);
    }
    .modal-header h4 {
      margin: 0;
      color: var(--cor-texto-titulo);
      font-size: 1.3em;
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }
    .modal-body .form-group {
      margin-bottom: 15px;
    }
    .modal-body .form-group label {
      font-weight: bold;
      font-size: 0.9em;
      margin-bottom: 5px;
      display: block;
    }
    
    /* Estilos do Editor Quill DENTRO do modal */
    #div-contexto-notas {
      min-height: 120px;
    }
    .ql-toolbar.ql-snow {
      border: 1px solid var(--cor-borda);
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      background-color: #fff;
    }
    .ql-container.ql-snow {
      border: 1px solid var(--cor-borda);
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      background-color: #fff;
    }
    .ql-editor {
      min-height: 120px;
      font-size: 1em;
    }
    /* --- FIM DA MUDAN√áA 2 --- */

  </style>
</head>
<body>

  <div id="splash-screen">
    <div class="spinner"></div>
    <div id="splash-text">A carregar dados do perfil de uso...</div>
  </div>

  <div class="container-lab" id="main-container" style="opacity: 0;">
    
    <div class="control-panel">
      <h4>Lab. Perfil de Uso</h4>
      <p style="font-size: 0.9em; margin-top: -10px; margin-bottom: 15px; border: none; padding: 0;">
        Analise os dados categ√≥ricos e num√©ricos da sua coorte.
      </p>
      
      <div class="control-group">
        <label for="select-x-agrupar">1. Agrupar Por (Eixo X):</label>
        <select id="select-x-agrupar">
          <option value="">A carregar colunas...</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="select-y-calcular">2. Calcular (Eixo Y):</label>
        <select id="select-y-calcular">
          <option value="">A carregar colunas...</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="select-chart-type">3. Tipo de Gr√°fico:</label>
        <select id="select-chart-type">
          <option value="bar">Gr√°fico de Barras</option>
          <option value="pie">Gr√°fico de Pizza</option>
          <option value="table">Tabela de Frequ√™ncia</option>
        </select>
      </div>
      
      <br>
      
      <div class="button-row">
        <button class="action" onclick="desenharGrafico()">üîÑ Gerar An√°lise "X por Y"</button>
        <button class="action-afixar" id="btn-afixar" onclick="abrirModalContexto()" disabled>
          üìå Afixar ao Relat√≥rio
        </button>
        </div>
      <div id="afixar-loading">A afixar...</div>

    </div>
    
     <div class="chart-container">
      <div id="graficoPlotly">
        </div>
    </div>
  </div>

  <div id="error-container">
    <h3>Falha ao Carregar o Laborat√≥rio</h3>
    <pre id="error-message"></pre>
  </div>


  <div class="modal-overlay" id="modal-contexto-overlay">
    <div class="modal-content">
      
      <div class="modal-header">
        <h4>Contextualizar e Afixar Bloco</h4>
      </div>
      
      <div class="modal-body">
        
        <div class="form-group">
          <label for="input-contexto-titulo">T√≠tulo do Gr√°fico:</label>
          <input type="text" id="input-contexto-titulo">
        </div>
        
        <div class_ ="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label for="input-contexto-eixox">T√≠tulo Eixo X:</label>
            <input type="text" id="input-contexto-eixox">
          </div>
          <div>
            <label for="input-contexto-eixoy">T√≠tulo Eixo Y:</label>
            <input type="text" id="input-contexto-eixoy">
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label>Anota√ß√£o R√°pida (Opcional):</label>
          <div id="div-contexto-notas"></div> 
        </div>

      </div>
      
      <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid var(--cor-borda); background-color: #fff; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <button class="secondary" onclick="fecharModalContexto()" style="width: auto; padding: 10px 20px; border-width: 2px;">Cancelar</button>
          
          <div id="loading-modal-salvar" style="display: none; font-size: 0.9em;">A salvar...</div>

          <button class="action" id="btn-salvar-contexto" onclick="salvarContextoECompletarAfixar()" style="width: auto; padding: 12px 28px;">
            Salvar no Gabinete
          </button>
        </div>
      </div>

    </div>
  </div>
  <script>
    let globalRawData = [];
    let infoProjeto = {};
    let colunasCategoricas = [];
    let colunasNumericas = [];

    let globalLastChartData = null;
    
    // --- MUDAN√áA 5: Vari√°vel para o novo editor ---
    let globalQuillContexto = null;
    const quillContextoOptions = {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ]
      },
      placeholder: 'Escreva a sua principal conclus√£o ou an√°lise aqui...'
    };
    // --- FIM DA MUDAN√áA 5 ---


    window.addEventListener('load', iniciarLab);
    function iniciarLab() {
      if (typeof Plotly === 'undefined' || typeof Quill === 'undefined') {
        mostrarPainelDeErro("Falha ao carregar bibliotecas externas (Plotly ou Quill).");
        return;
      }
      google.script.run
        .withSuccessHandler(onDadosRecebidos)
        .withFailureHandler(onErroAoReceber)
        .buscarDadosParaPerfilDeUso(); // (Perfil.gs.txt)
    }
    
    function onErroAoReceber(erro) {
      mostrarPainelDeErro(erro.message);
    }
    
    function onDadosRecebidos(dadosJsonString) {
      try {
        const dadosInjetados = JSON.parse(dadosJsonString);
        if (!dadosInjetados) throw new Error("O backend retornou 'null'.");
        if (dadosInjetados.sucesso === false) throw new Error(dadosInjetados.erro);
        
        console.log("Dados recebidos:", dadosInjetados);
        globalRawData = dadosInjetados.rawData;
        infoProjeto = dadosInjetados.info;
        
        processarColunas(dadosInjetados.rawData);
        popularDropdowns();
        mostrarConteudoPrincipal();
        
      } catch (e) {
        onErroAoReceber(e);
      }
    }

    function processarColunas(rawData) {
      if (rawData.length === 0) return;
      const primeiroEvento = rawData[0];
      const colunasIgnoradas = ['prontuario', 'dataNascPacienteMs', 'dataExameMs'];
      Object.keys(primeiroEvento).forEach(coluna => {
        if (colunasIgnoradas.includes(coluna)) return;
        
        const valor = primeiroEvento[coluna];
        if (typeof valor === 'number' && !isNaN(valor)) {
          colunasNumericas.push(coluna);
        } else {
          colunasCategoricas.push(coluna);
        }
      });
      
      console.log("Colunas Categ√≥ricas (X):", colunasCategoricas);
      console.log("Colunas Num√©ricas (Y):", colunasNumericas);
    }

    function popularDropdowns() {
      const selX = document.getElementById('select-x-agrupar');
      const selY = document.getElementById('select-y-calcular');
      selX.innerHTML = '';
      colunasCategoricas.sort().forEach(col => {
        selX.innerHTML += `<option value="${col}">${col}</option>`;
      });
      selY.innerHTML = '<option value="contagem_eventos">Contagem de Eventos</option>';
      colunasNumericas.sort().forEach(col => {
        selY.innerHTML += `<option value="soma_${col}">Soma de ${col}</option>`;
        selY.innerHTML += `<option value="media_${col}">M√©dia de ${col}</option>`;
      });
    }

    function desenharGrafico() {
      // Limpa o estado do bot√£o "Afixar"
      globalLastChartData = null;
      const btnAfixar = document.getElementById('btn-afixar');
      btnAfixar.disabled = true;
      btnAfixar.textContent = "üìå Afixar ao Relat√≥rio";

      const colunaX = document.getElementById('select-x-agrupar').value;
      const calculoY = document.getElementById('select-y-calcular').value;
      const tipoGrafico = document.getElementById('select-chart-type').value;
      
      if (!colunaX || !calculoY) {
        alert("Por favor, selecione ambos os eixos.");
        return;
      }

      // 1. Agrega os dados
      const agregador = {};
      
      globalRawData.forEach(row => {
        const categoria = String(row[colunaX] || "N/D").trim();
        if (!agregador[categoria]) {
          agregador[categoria] = [];
        }
        agregador[categoria].push(row);
      });
      // 2. Calcula os valores X e Y
      const labelsX = Object.keys(agregador).sort();
      const valoresY = [];
      const hoverText = [];

      labelsX.forEach(categoria => {
        const eventos = agregador[categoria];
        let valorCalculado = 0;
        let textoHover = "";

        if (calculoY === 'contagem_eventos') {
          valorCalculado = eventos.length;
          textoHover = `<b>${categoria}</b><br>Contagem: ${valorCalculado}`;
          
        } else 
        if (calculoY.startsWith('soma_')) {
          const nomeColunaNum = calculoY.replace('soma_', '');
          valorCalculado = eventos.reduce((soma, row) => soma + (parseFloat(row[nomeColunaNum]) || 0), 0);
          textoHover = `<b>${categoria}</b><br>Soma: ${valorCalculado.toFixed(2)}`;
          
        } else if (calculoY.startsWith('media_')) {
          const nomeColunaNum = calculoY.replace('media_', '');
          const valores = eventos.map(row => 
          parseFloat(row[nomeColunaNum]) || 0);
          valorCalculado = valores.reduce((s, v) => s + v, 0) / valores.length;
          textoHover = `<b>${categoria}</b><br>M√©dia: ${valorCalculado.toFixed(2)}`;
        }
        
        valoresY.push(valorCalculado);
        hoverText.push(textoHover);
      });
      
      // 3. Desenha o Gr√°fico
      let trace, layout;
      const tituloGrafico = `${calculoY.replace(/_/g, ' ')} POR ${colunaX}`;
      
      if (tipoGrafico === 'pie') {
        trace = {
          labels: labelsX,
          values: valoresY,
          text: hoverText,
          hoverinfo: 'text+percent+label',
          type: 'pie'
        };
        // Para Pizza, os eixos X e Y s√£o nulos
        layout = { title: tituloGrafico, xaxis: null, yaxis: null }; 
        
      } else if (tipoGrafico === 'table') {
        trace = {
          type: 'table',
          header: {
            values: [colunaX, calculoY.replace(/_/g, ' ')],
            align: "left",
            fill: { color: "var(--cor-primaria)" },
           font: { color: "white", size: 12, weight: "bold" }
          },
          cells: {
            values: [labelsX, valoresY.map(v => typeof v === 'number' ? v.toFixed(2) : v)],
            align: "left",
            fill: { color: "var(--cor-fundo-card)" }
          }
        
        };
        layout = { title: tituloGrafico };
        
      } else { // 'bar'
        trace = {
          x: labelsX,
          y: valoresY,
          text: hoverText,
          hoverinfo: 'text',
          type: 'bar',
          marker: { color: 'var(--cor-primaria)' }
        };
        layout = {
          title: tituloGrafico,
          xaxis: { title: colunaX },
          yaxis: { title: calculoY.replace(/_/g, ' ') }
        };
      }
      
      Plotly.newPlot('graficoPlotly', [trace], layout);
      
      if (tipoGrafico !== 'table') {
        globalLastChartData = {
          traces: [trace], 
          layout: layout,
          id: `grafico-${new Date().getTime()}` 
        };
        btnAfixar.disabled = false; 
      }
    }

    // --- MUDAN√áA 6: Novas Fun√ß√µes do Modal de Contexto ---
    
    function abrirModalContexto() {
      if (!globalLastChartData) {
        alert("Erro: N√£o h√° dados de gr√°fico para afixar.");
        return;
      }
      
      const layout = globalLastChartData.layout;
      
      // 1. Preencher os campos de texto com os dados atuais do gr√°fico
      document.getElementById('input-contexto-titulo').value = layout.title || "";
      
      // Verifica se xaxis existe (Gr√°ficos de Pizza n√£o t√™m)
      if (layout.xaxis) {
        document.getElementById('input-contexto-eixox').value = layout.xaxis.title || "";
        document.getElementById('input-contexto-eixox').disabled = false;
      } else {
        document.getElementById('input-contexto-eixox').value = "N/A (Gr√°fico de Pizza)";
        document.getElementById('input-contexto-eixox').disabled = true;
      }
      
      if (layout.yaxis) {
        document.getElementById('input-contexto-eixoy').value = layout.yaxis.title || "";
        document.getElementById('input-contexto-eixoy').disabled = false;
      } else {
        document.getElementById('input-contexto-eixoy').value = "N/A (Gr√°fico de Pizza)";
        document.getElementById('input-contexto-eixoy').disabled = true;
      }

      // 2. Inicializar o editor Quill
      if (!globalQuillContexto) {
        globalQuillContexto = new Quill('#div-contexto-notas', quillContextoOptions);
      }
      globalQuillContexto.setContents([]); // Limpa o editor
      
      // 3. Mostrar o modal
      document.getElementById('modal-contexto-overlay').style.display = 'flex';
    }
    
    function fecharModalContexto() {
      document.getElementById('modal-contexto-overlay').style.display = 'none';
      // (Opcional) Destruir o Quill, mas por enquanto vamos apenas limp√°-lo
      if (globalQuillContexto) {
        globalQuillContexto.setContents([]);
      }
      document.getElementById('loading-modal-salvar').style.display = 'none';
      document.getElementById('btn-salvar-contexto').disabled = false;
    }

    function salvarContextoECompletarAfixar() {
      if (!globalLastChartData) return;

      const btnSalvar = document.getElementById('btn-salvar-contexto');
      const loadingSalvar = document.getElementById('loading-modal-salvar');
      
      btnSalvar.disabled = true;
      loadingSalvar.style.display = 'block';

      // 1. Ler os novos t√≠tulos dos inputs
      const novoTitulo = document.getElementById('input-contexto-titulo').value;
      const novoEixoX = document.getElementById('input-contexto-eixox').value;
      const novoEixoY = document.getElementById('input-contexto-eixoy').value;
      
      // 2. Ler as notas do Quill
      const notasHtml = globalQuillContexto.root.innerHTML;
      
      // 3. Modificar o objeto de gr√°fico que vamos salvar
      globalLastChartData.layout.title = novoTitulo;
      if (globalLastChartData.layout.xaxis) {
        globalLastChartData.layout.xaxis.title = novoEixoX;
      }
      if (globalLastChartData.layout.yaxis) {
        globalLastChartData.layout.yaxis.title = novoEixoY;
      }

      // 4. Criar o "Bloco de Relat√≥rio" final, aqui no frontend
      const blocoParaSalvar = {
        tipo: "grafico",
        id: globalLastChartData.id,
        dadosGrafico: globalLastChartData, // O objeto Plotly com t√≠tulos atualizados
        notas: notasHtml                // O HTML das notas
      };

      // 5. Enviar o Bloco completo para o backend
      google.script.run
        .withSuccessHandler(onAfixarSucesso)
        .withFailureHandler(onAfixarErro)
        .afixarGraficoAoGabinete(JSON.stringify(blocoParaSalvar)); // (Perfil.gs)
    }


    function onAfixarSucesso(mensagem) {
      // Sucesso ao salvar no backend
      fecharModalContexto();
      
      const btnAfixar = document.getElementById('btn-afixar');
      const loadingAfixar = document.getElementById('afixar-loading');
      
      loadingAfixar.style.display = 'none';
      btnAfixar.textContent = '‚úÖ Afixado!';
      btnAfixar.disabled = true; // Desativa at√© o pr√≥ximo "Gerar Gr√°fico"
    }

    function onAfixarErro(erro) {
      // Erro ao salvar no backend
      const loadingSalvar = document.getElementById('loading-modal-salvar');
      loadingSalvar.style.display = 'block';
      loadingSalvar.textContent = `Erro: ${erro.message}`;
      
      document.getElementById('btn-salvar-contexto').disabled = false;
    }
    // --- FIM DA MUDAN√áA 6 ---


    // Fun√ß√µes de UI (sem altera√ß√µes)
    function mostrarPainelDeErro(mensagem) {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      const error = document.getElementById('error-container');
      splash.style.display = 'none';
      error.style.display = 'block';
      document.getElementById('error-message').textContent = mensagem;
      main.style.display = 'none';
    }
    function mostrarConteudoPrincipal() {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      splash.style.display = 'none'; 
      main.style.opacity = '1';
    }
  </script>
</body>
</html>

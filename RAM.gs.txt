/**
 * =============================================================
 * MÓDULO 11: ANÁLISE DE FARMACOVIGILÂNCIA (RAMs)
 * (v3 - Refatorado para aba 'FARMACOVIGILÂNCIA' dedicada)
 * =============================================================
 */

/**
 * Abre o novo pop-up "Análise de RAMs".
 * (Esta função permanece igual)
 */
function abrirModalAnaliseRAM() {
  const html = HtmlService.createHtmlOutputFromFile('AnaliseRAM')
    .setWidth(550)
    .setHeight(550);
  SpreadsheetApp.getUi().showModalDialog(html, 'Análise de Farmacovigilância');
}

/**
 * Função principal do "Construtor de Relatório de RAMs".
 * (v3 - LÊ DA NOVA ABA 'FARMACOVIGILÂNCIA')
 * @param {object} opcoes - Objeto com { modulosEstaticos: [], moduloTemporal: {} }
 */
function gerarAnaliseRAM(opcoes) {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // --- 1. Preparar a Aba de Relatório ---
  const nomeRelatorio = "Relatório de RAMs";
  let reportSheet = ss.getSheetByName(nomeRelatorio);
  if (reportSheet) reportSheet.clear();
  else reportSheet = ss.insertSheet(nomeRelatorio);
  ss.setActiveSheet(reportSheet);
  
  reportSheet.getRange("B1").setValue("Relatório de Farmacovigilância (RAMs) Gerado em: " + new Date().toLocaleString())
      .setFontWeight("bold").setFontSize(14);
  
  // --- 2. Ler os Dados (DE DUAS FONTES) ---
  
  // Fonte 1: Dados dos Pacientes (da Tabela)
  const patientMap = buildPatientMap_(); // Do Utils.gs
  
  // Fonte 2: Eventos de RAM (da nova aba FARMACOVIGILÂNCIA)
  const ramSheet = ss.getSheetByName(CONFIG.sheets.ramTab); // <-- MUDANÇA
  if (!ramSheet) throw new Error("Aba '" + CONFIG.sheets.ramTab + "' não encontrada.");
  
  const ramData = ramSheet.getDataRange().getValues();
  const ramHeaders = ramData.shift(); // Pega cabeçalhos

  // Encontra colunas essenciais na aba RAM
  const idxRamProntuario = ramHeaders.indexOf(CONFIG.headers.prontuario);
  const idxRamTipo = ramHeaders.indexOf(CONFIG.headers.ramTipo);
  const idxRamData = ramHeaders.indexOf(CONFIG.headers.ramData);
  const idxRamGravidade = ramHeaders.indexOf(CONFIG.headers.ramGravidade);
  const idxRamDesfecho = ramHeaders.indexOf(CONFIG.headers.ramDesfecho);

  if (idxRamProntuario === -1 || idxRamTipo === -1) {
    throw new Error(`Colunas '${CONFIG.headers.prontuario}' e/ou '${CONFIG.headers.ramTipo}' não encontradas na aba '${CONFIG.sheets.ramTab}'.`);
  }
  
  // Filtra 'ramData' para conter APENAS eventos válidos (com prontuário e tipo)
  const eventosRAM = ramData.filter(row => row[idxRamProntuario] && row[idxRamTipo]);
  Logger.log(`Encontrados ${eventosRAM.length} eventos de RAM para análise.`);

  let currentRow = 4; // Linha inicial
  const chartWidth = 550;
  const chartHeight = 350;
  let erros = []; 

  // --- 3. Roteador de Módulos Estáticos ---
  
  // --- MÓDULO: Frequência por Tipo de RAM ---
  if (opcoes.modulosEstaticos.includes("freqPorTipo")) {
    Logger.log("Tentando gerar 'freqPorTipo'...");
    const contagem = {};
    eventosRAM.forEach(row => {
      const ram = row[idxRamTipo] || "N/D";
      contagem[ram] = (contagem[ram] || 0) + 1;
    });
    const dadosGrafico = [["Tipo de RAM", "Contagem"]];
    Object.keys(contagem).forEach(key => dadosGrafico.push([key, contagem[key]]));
    if (dadosGrafico.length > 1) {
      currentRow = gerarGrafico_(reportSheet, "Frequência por Tipo de RAM", Charts.ChartType.PIE, dadosGrafico, currentRow, chartWidth, chartHeight);
    }
  }
  
  // --- MÓDULO: Incidência por Sexo ---
  if (opcoes.modulosEstaticos.includes("freqPorSexo")) {
    Logger.log("Tentando gerar 'freqPorSexo'...");
    if (idxRamTipo === -1) { // idxSexo é verificado dentro do loop
      erros.push("Módulo 'Incidência por Sexo' pulado: Coluna '" + CONFIG.headers.ramTipo + "' não encontrada.");
    } else {
      const contagem = {}; 
      eventosRAM.forEach(row => {
        const prontuario = row[idxRamProntuario];
        const patient = patientMap[prontuario]; // Junta com dados da Tabela
        const sexo = (patient && patient.sexo) ? patient.sexo : "N/D";
        contagem[sexo] = (contagem[sexo] || 0) + 1;
      });
      const dadosGrafico = [["Sexo", "Nº de RAMs"]];
      Object.keys(contagem).forEach(key => dadosGrafico.push([key, contagem[key]]));
      if (dadosGrafico.length > 1) {
        currentRow = gerarGrafico_(reportSheet, "Incidência de RAMs por Sexo", Charts.ChartType.COLUMN, dadosGrafico, currentRow, chartWidth, chartHeight);
      }
    }
  }

  // --- MÓDULO: Incidência por Prematuridade ---
  if (opcoes.modulosEstaticos.includes("freqPorPrematuridade")) {
    Logger.log("Tentando gerar 'freqPorPrematuridade'...");
    // idxGestacao é verificado dentro do loop
    const contagem = {};
    eventosRAM.forEach(row => {
       const prontuario = row[idxRamProntuario];
       const patient = patientMap[prontuario]; // Junta com dados da Tabela
       let classificacao = "Padrão/Outro";
       if (patient && patient.éPrematuro) classificacao = "Prematuro";
       else if (patient) classificacao = "Padrão";
       
       contagem[classificacao] = (contagem[classificacao] || 0) + 1;
    });
    const dadosGrafico = [["Classificação", "Nº de RAMs"]];
    Object.keys(contagem).forEach(key => dadosGrafico.push([key, contagem[key]]));
    if (dadosGrafico.length > 1) {
       currentRow = gerarGrafico_(reportSheet, "Incidência de RAMs por Prematuridade", Charts.ChartType.COLUMN, dadosGrafico, currentRow, chartWidth, chartHeight);
    }
  }

  // --- MÓDULO: Frequência por Gravidade ---
  if (opcoes.modulosEstaticos.includes("freqPorGravidade")) {
    Logger.log("Tentando gerar 'freqPorGravidade'...");
    if (idxRamGravidade === -1) {
      erros.push("Módulo 'Frequência por Gravidade' pulado: Coluna '" + CONFIG.headers.ramGravidade + "' não encontrada.");
    } else {
      const agregador = {};
      const todasGravidades = new Set();
      eventosRAM.forEach(row => {
         const ram = row[idxRamTipo];
         const gravidade = row[idxRamGravidade] || "N/D";
         if (!agregador[ram]) agregador[ram] = {};
         agregador[ram][gravidade] = (agregador[ram][gravidade] || 0) + 1;
         todasGravidades.add(gravidade);
      });
      const gravidadesOrdenadas = Array.from(todasGravidades).sort();
      const dadosGrafico = [["Tipo de RAM", ...gravidadesOrdenadas]]; 
      Object.keys(agregador).sort().forEach(ram => {
        const linha = [ram];
        gravidadesOrdenadas.forEach(gravidade => {
          linha.push(agregador[ram][gravidade] || 0);
        });
        dadosGrafico.push(linha);
      });
      if (dadosGrafico.length > 1) {
         currentRow = gerarGrafico_(reportSheet, "Frequência de RAMs por Gravidade", Charts.ChartType.COLUMN, dadosGrafico, currentRow, chartWidth, chartHeight, true); // true = stacked
      }
    }
  }
  
  // --- MÓDULO: Desfecho das RAMs Graves ---
  if (opcoes.modulosEstaticos.includes("desfechoDasGraves")) {
    Logger.log("Tentando gerar 'desfechoDasGraves'...");
    if (idxRamDesfecho === -1 || idxRamGravidade === -1) {
      erros.push("Módulo 'Desfecho das Graves' pulado: Coluna '" + CONFIG.headers.ramDesfecho + "' ou '" + CONFIG.headers.ramGravidade + "' não encontrada.");
    } else {
      const contagem = {};
      eventosRAM.forEach(row => {
         const gravidade = row[idxRamGravidade];
         if (gravidade === "Grave/Séria") {
           const desfecho = row[idxRamDesfecho] || "Desconhecido";
           contagem[desfecho] = (contagem[desfecho] || 0) + 1;
         }
      });
      const dadosGrafico = [["Desfecho", "Contagem"]];
      Object.keys(contagem).forEach(key => dadosGrafico.push([key, contagem[key]]));
      if (dadosGrafico.length > 1) {
         currentRow = gerarGrafico_(reportSheet, "Desfecho das RAMs Graves/Sérias", Charts.ChartType.PIE, dadosGrafico, currentRow, chartWidth, chartHeight);
      }
    }
  }

  // --- 4. Roteador de Módulo Temporal ---
  if (opcoes.moduloTemporal.medicamento) {
    Logger.log("Tentando gerar 'Análise Temporal de RAMs'...");
    if (idxRamData === -1) {
      erros.push("Módulo 'Análise Temporal' pulado: Coluna '" + CONFIG.headers.ramData + "' não encontrada na aba '" + CONFIG.sheets.ramTab + "'.");
    } else {
      try {
        // Passa os 'eventosRAM' já filtrados e os cabeçalhos da aba RAM
        const dadosTemporais = calcularTendemciaRAMs_(opcoes.moduloTemporal, eventosRAM, ramHeaders);
        if (dadosTemporais.length > 1) {
          currentRow = gerarGrafico_(reportSheet, `Tendência de RAMs vs. ${opcoes.moduloTemporal.medicamento}`, Charts.ChartType.LINE, dadosTemporais, currentRow, chartWidth, chartHeight);
        } else {
          erros.push(`Não foi possível gerar a Análise Temporal (sem dados de RAM com data).`);
        }
      } catch (e) {
        erros.push("Erro na Análise Temporal: " + e.message);
        Logger.log("Erro na Análise Temporal de RAMs: " + e.message);
      }
    }
  }

  // --- 5. Finalização ---
  let msgFinal = `Relatório de RAMs gerado.`;
  if (erros.length > 0) {
    msgFinal += "\n\nAvisos:\n" + erros.join('\n');
    Logger.log("Erros/Avisos do relatório de RAMs: " + erros.join(', '));
  }
  
  ui.alert("Sucesso!", msgFinal, ui.ButtonSet.OK);
  return "Sucesso";
}


/**
 * HELPER TEMPORAL: Calcula a tendência de RAMs.
 * (v3 - LÊ DA NOVA ABA 'FARMACOVIGILÂNCIA')
 * @return {Array} Dados prontos para o gráfico.
 */
function calcularTendemciaRAMs_(opcoesTemporal, eventosRAM, ramHeaders) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ONE_DAY_MS = 1000 * 60 * 60 * 24;

  // --- A. Encontrar Data Início (Dia 0) ---
  const prescricaoSheet = ss.getSheetByName(CONFIG.sheets.prescricao);
  if (!prescricaoSheet) throw new Error("Aba '" + CONFIG.sheets.prescricao + "' não encontrada.");
  
  const prescricaoData = prescricaoSheet.getDataRange().getValues();
  const hPresc = prescricaoData.shift();
  const idxPrescPront = hPresc.indexOf(CONFIG.headers.prontuario);
  const idxPrescData = hPresc.indexOf(CONFIG.headers.dataInicio);
  const idxPrescMed = hPresc.indexOf(CONFIG.headers.medicamento);

  const pacientesAlvo = {}; // { "prontuario": 123456789 (timestamp) }
  prescricaoData.forEach(row => {
    const prontuario = row[idxPrescPront];
    const medicamento = row[idxPrescMed];
    const dataInicio = new Date(row[idxPrescData]);
    if (medicamento === opcoesTemporal.medicamento) {
      if (!pacientesAlvo[prontuario] || dataInicio < pacientesAlvo[prontuario]) {
        pacientesAlvo[prontuario] = dataInicio.getTime(); 
      }
    }
  });

  // --- B. Encontrar Data da RAM (usando cabeçalhos da aba RAM) ---
  const idxRamData = ramHeaders.indexOf(CONFIG.headers.ramData); 
  const idxProntuario = ramHeaders.indexOf(CONFIG.headers.prontuario);
  
  // --- C. Agrupar (Bucket) RAMs ---
  const buckets = {}; // { "-1": 2, "0": 5, "1": 3 } (Contagem, não média)

  eventosRAM.forEach(row => { // Usa 'eventosRAM' pré-filtrados
    const prontuario = row[idxProntuario];
    
    // Verifica se este paciente está na coorte do medicamento
    if (pacientesAlvo[prontuario]) {
      const dataRam = new Date(row[idxRamData]);
      if (isNaN(dataRam.getTime())) return; // Pula se a data da RAM for inválida
      
      const dataIntervencao = pacientesAlvo[prontuario];
      const diasRelativos = Math.floor((dataRam.getTime() - dataIntervencao) / ONE_DAY_MS);
      
      let bucketId;
      if (opcoesTemporal.agrupamento === "semana") bucketId = Math.floor(diasRelativos / 7);
      else if (opcoesTemporal.agrupamento === "mes") bucketId = Math.floor(diasRelativos / 30.44);
      else bucketId = diasRelativos;
      
      buckets[bucketId] = (buckets[bucketId] || 0) + 1;
    }
  });
  
  // --- D. Formatar para Gráfico ---
  const nomeEixoX = `Período (${opcoesTemporal.agrupamento})`;
  const dadosGrafico = [[nomeEixoX, "Contagem de RAMs", { role: 'annotation' }]];
  const bucketsOrdenados = Object.keys(buckets).map(Number).sort((a, b) => a - b);
  
  bucketsOrdenados.forEach(bucketId => {
    const contagem = buckets[bucketId];
    let anotacao = null;
    if (bucketId === 0) anotacao = "Início da Medicação";
    dadosGrafico.push([bucketId, contagem, anotacao]);
  });

  return dadosGrafico;
}
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  
  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent(); ?>
  
  <style>
    body {
      background-color: var(--cor-fundo-app);
      padding: 32px; 
      overflow-y: auto;
    }
    
    .container-centralizado {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    
    .mapping-group { margin-bottom: 15px; }
    .mapping-group label {
        font-size: 0.9em;
        font-weight: bold;
        margin-bottom: 4px;
        display: block;
    }
    .mapping-group select {
        padding: 8px;
        font-size: 0.9em;
        background-color: #fff;
    }
    
    .block p {
      text-align: left;
      border: none;
      padding: 0;
      font-size: 0.9em; 
      margin-top: -10px; 
      margin-bottom: 15px;
    }
    
    .block + .block {
      margin-top: 24px;
    }
    
    .block .label {
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      margin-top: 10px; 
    }
    .card > .block:first-child .label:first-child {
      margin-top: 0;
    }
    
    details {
      background-color: var(--cor-fundo-app);
      border: 1px dashed var(--cor-primaria);
      border-radius: var(--border-radius);
      padding: 10px 15px;
      margin-bottom: 24px; 
    }
    summary {
      font-weight: bold;
      color: var(--cor-primaria);
      cursor: pointer;
    }
    
    .footer {
      display: grid;
      grid-template-columns: 1fr 1fr; 
      gap: 15px;
      align-items: center;
    }
    
    /* **** BOT√ÉO ATUALIZADO **** */
    button.action-perfil { /* Antigo 'action-protocolo' */
      font-size: 1.1em; font-weight: bold; color: #fff;
      border: none; padding: 14px 28px; border-radius: 6px;
      cursor: pointer; transition: all 0.2s ease;
      width: 100%; box-sizing: border-box;
      background-color: #00573D; /* Verde Escuro (era cinza) */
    }
    button.action-perfil:hover { background-color: #004a32; }
    
  </style>
</head>
<body>

  <div id="splash-screen">
    <div class="spinner"></div>
    <div id="splash-text">A carregar dados de configura√ß√£o...</div>
  </div>

  <div class="container-centralizado" id="main-container" style="opacity: 0; transition: opacity 0.5s ease-in;">
    
    <div class="header">
      <h3>Configurador de An√°lise</h3>
      <p>Mapeie as suas fontes de dados para carregar o laborat√≥rio.</p>
    </div>
    
    <div class="card">
      
      <details>
        <summary>O que faz esta ferramenta?</summary>
        <div style="line-height: 1.6; margin-top: 10px; padding: 10px 5px;">
          <p style="font-size: 0.9em;">Este √© o motor de an√°lise central.</p>
          <p style="font-size: 0.9em;"><b>Passo 1: Fatos (Eventos)</b><br>Mapeie a sua aba de dados brutos (ex: 'Prescri√ß√£o de Doses').</p>
          <p style="font-size: 0.9em;"><b>Passo 2: Dimens√µes (Pacientes)</b><br>Mapeie a sua aba de demografia (ex: 'MENU PRINCIPAL').</p>
          <p style="font-size: 0.9em;">Ap√≥s mapear, clique num dos bot√µes no rodap√© para iniciar a an√°lise.</p>
        </div>
      </details>
      
      <div class="block">
        <label class="label">1. Mapeamento de Fatos (Eventos)</label>
        
        <div class="grid-2">
          <div class="mapping-group">
            <label for="map-aba-fatos">Aba de Fatos (Eventos):</label>
            <select id="map-aba-fatos" onchange="popularDropdownsMapeamento()">
            </select>
          </div>
          <div class="mapping-group">
            <label for="map-fatos-intervencao">Coluna da Interven√ß√£o (ex: Medicamento):</label>
            <select id="map-fatos-intervencao" class="map-fatos" onchange="popularDropdownValores()"></select>
          </div>
        </div>
        
        <div class="mapping-group">
            <label for="map-intervencao-valor">Valor da Interven√ß√£o (Dia 0):</label>
            <select id="map-intervencao-valor">
              <option value="">-- Aguardando Coluna --</option>
            </select>
        </div>
        
        <hr style="border:0; border-top: 1px solid #eee; margin: 15px 0;">

        <div class="grid-3">
          <div class="mapping-group">
            <label for="map-fatos-prontuario">Prontu√°rio (Fatos):</label>
            <select id="map-fatos-prontuario" class="map-fatos"></select>
          </div>
          <div class="mapping-group">
            <label for="map-fatos-data-inicio">Data In√≠cio (Evento):</label>
            <select id="map-fatos-data-inicio" class="map-fatos"></select>
          </div>
          <div class="mapping-group">
            <label for="map-fatos-codigo-med">C√≥digo do Medicamento:</label>
            <select id="map-fatos-codigo-med" class="map-fatos"></select>
          </div>
          <div class="mapping-group">
            <label for="map-fatos-dose">Valor da Dose (ex: 5):</label>
            <select id="map-fatos-dose" class="map-fatos"></select>
          </div>
          <div class="mapping-group">
            <label for="map-fatos-unidade">Unidade da Dose (ex: "ML"):</label>
            <select id="map-fatos-unidade" class="map-fatos"></select>
          </div>
        </div>
      </div>
      
      <div class="block">
        <label class="label">2. Mapeamento de Dimens√µes (Pacientes)</label>
        
        <div class="grid-3">
          <div class="mapping-group">
            <label for="map-aba-dimensoes">Aba de Dimens√µes:</label>
            <select id="map-aba-dimensoes" onchange="popularDropdownsMapeamento()">
            </select>
          </div>
          <div class="mapping-group">
            <label for="map-dim-prontuario">Prontu√°rio (Dimens√µes):</label>
            <select id="map-dim-prontuario" class="map-dim"></select>
          </div>
          <div class="mapping-group">
            <label for="map-dim-data-nasc">Data de Nascimento:</label>
            <select id="map-dim-data-nasc" class="map-dim"></select>
          </div>
        </div>
        
        <hr style="border:0; border-top: 1px solid #eee; margin: 15px 0;">
        <label class="label" style="font-size: 1em;">Mapeamento Opcional (Para Filtros e Divis√µes)</label>
        
        <div class="grid-3">
          <div class="mapping-group">
            <label for="map-dim-sexo">Coluna 'Sexo':</label>
            <select id="map-dim-sexo" class="map-dim"></select>
          </div>
          <div class="mapping-group">
            <label for="map-dim-gestacao">Coluna 'Idade Gestacional':</label>
            <select id="map-dim-gestacao" class="map-dim"></select>
          </div>
          <div class="mapping-group">
            <label for="map-dim-divisao">Coluna de Divis√£o (ex: Marca):</label>
            <select id="map-dim-divisao" class="map-dim"></select>
          </div>
        </div>
      </div>
      
    </div> <div class="footer">
      <button class="action" onclick="iniciarAnalise('eficacia')">
        üß™ Lab de Efic√°cia (Temporal)
      </button>
      <button class="action-ram" onclick="iniciarAnalise('seguranca')">
        üõ°Ô∏è Lab de Seguran√ßa (Incid√™ncia)
      </button>
      
      <button class="action-perfil" onclick="iniciarAnalise('perfil')">
        üìà Lab de Perfil de Uso (X por Y)
      </button>
      
      <div id="loading" style="grid-column: 1 / -1;"><p>A carregar...</p></div>
      <div id="error" style="grid-column: 1 / -1;"></div>
    </div>
  </div>

  <script>
    // (O JavaScript √© o mesmo da Fase B anterior, com a chamada 'perfil' adicionada)
    let globalColunas = {}; 
    let globalAbas = [];
    const abasSugeridas = {
      fatos: "Prescri√ß√£o de Doses",
      dimensoes: "MENU PRINCIPAL"
    };
    const nomesPadrao = {
      fatosProntuario: "PRONTU√ÅRIO",
      fatosDataInicio: "DATA_INICIO",
      fatosIntervencao: "MEDICAMENTO", 
      fatosCodigoMed: "CODIGO_MED",
      fatosDose: "DOSE_PRESCRITA",
      fatosUnidade: "UN_PRESCRITA",
      dimProntuario: "PRONTU√ÅRIO",
      dimDataNasc: "DATA_NASCIMENTO",
      dimSexo: "SEXO",
      dimGestacao: "IDADE GESTACIONAL",
      dimDivisao: "" 
    };

    window.addEventListener('load', function() {
      google.script.run
        .withSuccessHandler(onSetupDataLoaded)     
        .withFailureHandler(onDataError)      
        .obterDadosParaSetupAnalise(); // (ANALISE.GS)
    });
    
    function onSetupDataLoaded(dados) {
      if (dados.erro) {
        mostrarConteudoPrincipal({ message: dados.erro });
        return;
      }
      
      const colunasRecebidas = dados.colunas || [];
      globalAbas = dados.abas || [];
      
      globalColunas = {};
      colunasRecebidas.forEach(col => {
        if (!globalColunas[col.nomeAba]) {
          globalColunas[col.nomeAba] = [];
        }
        globalColunas[col.nomeAba].push(col.nomeColuna);
      });
      
      const selAbaFatos = document.getElementById('map-aba-fatos');
      const selAbaDimensoes = document.getElementById('map-aba-dimensoes');
      
      globalAbas.forEach(aba => {
        selAbaFatos.innerHTML += `<option value="${aba}">${aba}</option>`;
        selAbaDimensoes.innerHTML += `<option value="${aba}">${aba}</option>`;
      });
      
      if (globalAbas.includes(abasSugeridas.fatos)) {
        selAbaFatos.value = abasSugeridas.fatos;
      }
      if (globalAbas.includes(abasSugeridas.dimensoes)) {
        selAbaDimensoes.value = abasSugeridas.dimensoes;
      }
      
      popularDropdownsMapeamento();
      mostrarConteudoPrincipal(null);
    }

    function popularDropdownsMapeamento() {
      const abaFatosSel = document.getElementById('map-aba-fatos').value;
      const abaDimSel = document.getElementById('map-aba-dimensoes').value;
      const colunasFatos = globalColunas[abaFatosSel] || [];
      const colunasDimensoes = globalColunas[abaDimSel] || [];
      
      populateSelect('map-fatos-prontuario', colunasFatos, nomesPadrao.fatosProntuario);
      populateSelect('map-fatos-data-inicio', colunasFatos, nomesPadrao.fatosDataInicio, "DTHR_INICIO");
      populateSelect('map-fatos-intervencao', colunasFatos, nomesPadrao.fatosIntervencao); 
      populateSelect('map-fatos-codigo-med', colunasFatos, nomesPadrao.fatosCodigoMed);
      populateSelect('map-fatos-dose', colunasFatos, nomesPadrao.fatosDose);
      populateSelect('map-fatos-unidade', colunasFatos, nomesPadrao.fatosUnidade);
      
      populateSelect('map-dim-prontuario', colunasDimensoes, nomesPadrao.dimProntuario);
      populateSelect('map-dim-data-nasc', colunasDimensoes, nomesPadrao.dimDataNasc);
      populateSelect('map-dim-sexo', colunasDimensoes, nomesPadrao.dimSexo);
      populateSelect('map-dim-gestacao', colunasDimensoes, nomesPadrao.dimGestacao);
      populateSelect('map-dim-divisao', colunasDimensoes, nomesPadrao.dimDivisao);
      
      popularDropdownValores();
    }
    
    function populateSelect(selectId, colunas, nomePadrao, altStartsWith = null) {
      const selectEl = document.getElementById(selectId);
      if (!selectEl) return;
      const valorAntigo = selectEl.value;
      selectEl.innerHTML = '<option value="">-- Mapear Coluna --</option>';
      let padraoEncontrado = false;
      colunas.forEach(coluna => {
        let selected = '';
        if (coluna.toUpperCase() === nomePadrao.toUpperCase()) {
          selected = 'selected';
          padraoEncontrado = true;
        }
        selectEl.innerHTML += `<option value="${coluna}" ${selected}>${coluna}</option>`;
      });
      if (!padraoEncontrado && altStartsWith) {
         const alt = colunas.find(c => c.toUpperCase().startsWith(altStartsWith.toUpperCase()));
         if (alt) selectEl.value = alt;
      }
      if (colunas.includes(valorAntigo)) {
        selectEl.value = valorAntigo;
      }
    }
    
    function popularDropdownValores() {
      const aba = document.getElementById('map-aba-fatos').value;
      const coluna = document.getElementById('map-fatos-intervencao').value;
      const select = document.getElementById('map-intervencao-valor');
      
      if (!aba || !coluna) {
        select.innerHTML = '<option value="">-- Mapeie a coluna de interven√ß√£o --</option>';
        return;
      }
      
      select.innerHTML = '<option value="">A carregar valores...</option>';
      select.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(valores) {
          if (valores.erro) {
            mostrarErro({ message: valores.erro });
            return;
          }
          select.innerHTML = '';
          if (valores.length === 0) {
            select.innerHTML = '<option disabled selected>Nenhum valor encontrado</option>';
            return;
          }
          select.innerHTML = '<option value="" disabled selected>-- Selecione um valor --</option>';
          valores.forEach(function(val) {
            select.appendChild(new Option(val, val));
          });
          select.disabled = false;
        })
        .withFailureHandler(mostrarErro)
        .obterValoresUnicosDaColuna(aba, coluna); // (ANALISE.GS)
    }

    function onDataError(erro) {
      mostrarConteudoPrincipal(erro);
    }
    function mostrarConteudoPrincipal(erro) {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      splash.style.opacity = '0';
      setTimeout(function() {
        splash.style.display = 'none'; 
        main.style.opacity = '1'; 
        if (erro) {
          mostrarErro(erro);
        }
      }, 500); 
    }
    
    function iniciarAnalise(tipoLaboratorio) {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      
      const mapeamento = {
        fatos: {
          aba: document.getElementById('map-aba-fatos').value,
          prontuario: document.getElementById('map-fatos-prontuario').value,
          dataInicio: document.getElementById('map-fatos-data-inicio').value,
          intervencao: document.getElementById('map-fatos-intervencao').value,
          codigoMed: document.getElementById('map-fatos-codigo-med').value,
          dose: document.getElementById('map-fatos-dose').value,
          unidade: document.getElementById('map-fatos-unidade').value
        },
        dimensoes: {
          aba: document.getElementById('map-aba-dimensoes').value,
          prontuario: document.getElementById('map-dim-prontuario').value,
          dataNasc: document.getElementById('map-dim-data-nasc').value,
          sexo: document.getElementById('map-dim-sexo').value || null,
          gestacao: document.getElementById('map-dim-gestacao').value || null,
          divisao: document.getElementById('map-dim-divisao').value || null
        }
      };
      
      const medicamentoAlvo = document.getElementById('map-intervencao-valor').value;

      try {
        if (!medicamentoAlvo) {
          throw new Error("Por favor, selecione um Valor da Interven√ß√£o (Dia 0).");
        }
        if (!mapeamento.fatos.aba || !mapeamento.fatos.prontuario || !mapeamento.fatos.dataInicio || !mapeamento.fatos.intervencao || !mapeamento.fatos.codigoMed || !mapeamento.fatos.dose || !mapeamento.fatos.unidade) {
          throw new Error("Mapeamento de Fatos (Eventos) incompleto. Por favor, preencha todos os campos.");
        }
        if (!mapeamento.dimensoes.aba || !mapeamento.dimensoes.prontuario || !mapeamento.dimensoes.dataNasc) {
          throw new Error("Mapeamento de Dimens√µes (Pacientes) incompleto. Preencha pelo menos Aba, Prontu√°rio e Data de Nascimento.");
        }
      } catch (e) {
        mostrarErro(e);
        loading.style.display = 'none';
        return;
      }
      
      const opcoes = {
        medicamentoAlvo: medicamentoAlvo, 
        mapeamento: mapeamento
      };
      
      document.getElementById('main-container').style.opacity = '0';
      document.body.style.backgroundColor = 'var(--cor-fundo-card)'; 
      const splash = document.getElementById('splash-screen');
      const splashText = document.getElementById('splash-text');
      splash.style.display = 'flex';
      splash.style.opacity = '1';

      if (tipoLaboratorio === 'eficacia') {
        splashText.innerHTML = 'A preparar Lab de Efic√°cia<span class="loading-dots"></span>';
        google.script.run
          .withSuccessHandler(analiseCompleta)
          .withFailureHandler(mostrarErro)
          .abrirModalGraficoInterativo(opcoes); // (ANALISE.GS)
          
      } else if (tipoLaboratorio === 'seguranca') {
        splashText.innerHTML = 'A preparar Lab de Seguran√ßa<span class="loading-dots"></span>';
        google.script.run
          .withSuccessHandler(analiseCompleta)
          .withFailureHandler(mostrarErro)
          .abrirModalLaboratorioRAM(opcoes); // (RAM.gs.txt)
          
      } else if (tipoLaboratorio === 'perfil') {
        splashText.innerHTML = 'A preparar Lab de Perfil de Uso<span class="loading-dots"></span>';
        google.script.run
          .withSuccessHandler(analiseCompleta)
          .withFailureHandler(mostrarErro)
          .abrirModalPerfilDeUso(opcoes); // <-- (Perfil.gs.txt)
          
      } else {
         // Fallback caso um bot√£o antigo (como 'custo') ainda esteja l√°
         mostrarErro({ message: `Tipo de laborat√≥rio '${tipoLaboratorio}' n√£o reconhecido.`});
      }
    }

    function analiseCompleta(mensagem) {
      google.script.host.close();
    }
    
    function mostrarErro(erro) {
      document.getElementById('splash-screen').style.display = 'none';
      document.getElementById('main-container').style.opacity = '1';
      document.body.style.backgroundColor = 'var(--cor-fundo-app)';
      const errorDiv = document.getElementById('error');
      errorDiv.style.display = 'block';
      errorDiv.textContent = 'Erro: ' + erro.message;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  
  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent(); ?>

  <style>
    body {
      padding: 32px;
    }
    
    h3 {
      /* Cor verde específica para o Setup */
      color: #00573D;
    }
    
    p {
      font-size: 1.1em;
      text-align: center;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--cor-borda);
    }
    
    .block {
      margin-bottom: 16px;
    }
    
    .label {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--cor-texto-titulo);
      margin-bottom: 10px;
      display: block;
    }
    
    .checkbox-group label {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .checkbox-group label:hover {
      background-color: var(--cor-fundo-app);
    }
    .checkbox-group input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 12px;
      accent-color: var(--cor-primaria);
    }

    .hint {
      font-size: 0.9em;
      color: #777;
      font-style: italic;
      margin-left: 32px; /* Alinha com o texto do checkbox */
      margin-top: -8px;
      margin-bottom: 10px;
      display: block;
    }
    
  </style>
</head>
<body>
  
  <div class="container" style="padding: 0;"> <h3>Construtor de Relatório Modular</h3>
    <p>Selecione os "blocos" de análise para incluir no seu relatório estático.</p>

    <div class="block">
      <label class="label">Blocos Demográficos:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="modulo" value="contagemSexo"> Contagem por Sexo</label>
        <span class="hint">(i) Necessita da coluna: `SEXO` na aba 'MENU PRINCIPAL'.</span>
        
        <label><input type="checkbox" name="modulo" value="contagemPrematuridade"> Contagem por Prematuridade</label>
        <span class="hint">(i) Necessita da coluna: `IDADE GESTACIONAL` na aba 'MENU PRINCIPAL'.</span>
      </div>
    </div>

    <div class="block">
      <label class="label">Blocos de Desfecho (Custo/Duração):</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="modulo" value="custoPorSexo"> Custo Médio por Sexo</label>
        <span class="hint">(i) Necessita das colunas: `CUSTO TOTAL TRATAMENTO PCTE` e `SEXO`.</span>

        <label><input type="checkbox" name="modulo" value="duracaoPorPrematuridade"> Duração Média por Prematuridade</label>
        <span class="hint">(i) Necessita das colunas: `TRATAMENTO (DIAS)` e `IDADE GESTACIONAL`.</span>
      </div>
    </div>

    <div class="block">
      <button class="action" onclick="iniciarGeracao()">Gerar Relatório Modular</button>
    </div>

    <div id="loading"><p>Gerando relatório... Por favor, aguarde.</p></div>
    <div id="error"></div>
  </div>

  <script>
    function iniciarGeracao() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';

      const modulosSelecionados = [];
      const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
      checkboxes.forEach(function(chk) {
        modulosSelecionados.push(chk.value);
      });

      if (modulosSelecionados.length === 0) {
        mostrarErro({ message: "Por favor, selecione pelo menos um módulo." });
        return;
      }
      
      google.script.run
        .withSuccessHandler(geracaoCompleta)
        .withFailureHandler(mostrarErro)
        .gerarRelatorioModular(modulosSelecionados);
    }

    function geracaoCompleta(mensagem) {
      document.getElementById('loading').style.display = 'none';
      google.script.host.close();
    }

    function mostrarErro(erro) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Erro: ' + erro.message;
    }
  </script>
</body>
</html>

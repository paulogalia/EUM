<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
  
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('Estilos').getContent(); ?>
  
  <style>
    /* Adiciona estilos para os filtros din√¢micos */
    .filtro-dinamico-group {
      border: 1px solid var(--cor-borda);
      border-radius: var(--border-radius);
      padding: 10px;
      margin-bottom: 15px;
    }
    .filtro-dinamico-group label {
      font-weight: bold;
      font-size: 0.9em;
      color: var(--cor-primaria);
    }
    .filtro-dinamico-group select {
      margin-top: 5px;
    }
    
    /* === MUDAN√áA 2: Estilos para o Modal de Contexto === */
    .modal-overlay {
      display: none; /* Come√ßa escondido */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 100;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background-color: var(--cor-fundo-app); /* Fundo cinza */
      width: 90%;
      max-width: 700px;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cor-borda);
    }
    .modal-header h4 {
      margin: 0;
      color: var(--cor-texto-titulo);
      font-size: 1.3em;
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }
    .modal-body .form-group {
      margin-bottom: 15px;
    }
    .modal-body .form-group label {
      font-weight: bold;
      font-size: 0.9em;
      margin-bottom: 5px;
      display: block;
    }
    
    /* Estilos do Editor Quill DENTRO do modal */
    #div-contexto-notas {
      min-height: 120px;
    }
    .ql-toolbar.ql-snow {
      border: 1px solid var(--cor-borda);
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      background-color: #fff;
    }
    .ql-container.ql-snow {
      border: 1px solid var(--cor-borda);
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      background-color: #fff;
    }
    .ql-editor {
      min-height: 120px;
      font-size: 1em;
    }
    
    /* (NOVO) Estilo para a caixa de Resultados Estat√≠sticos */
    #contexto-resultados-estatisticos {
      background-color: #f4f4f4;
      border: 1px solid var(--cor-borda);
      border-radius: 4px;
      padding: 10px 15px;
      font-family: monospace;
      font-size: 0.9em;
      color: #333;
      white-space: pre-wrap; /* Mant√©m as quebras de linha */
    }
    /* === FIM DA MUDAN√áA 2 === */
    
    /* Bot√£o Afixar (copiado do PerfilDeUso) */
    button.action-afixar {
      font-size: 1em; 
      font-weight: bold;
      background-color: #fff;
      border: 2px solid #00573D; /* Verde escuro */
      color: #00573D;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      box-sizing: border-box;
    }
    button.action-afixar:hover {
      background-color: #f0f5f3;
    }
    button.action-afixar:disabled {
      background-color: #eee;
      border-color: #aaa;
      color: #aaa;
      cursor: not-allowed;
    }
    #afixar-loading {
      display: none;
      text-align: center;
      font-size: 0.9em;
      margin-top: 8px;
    }

  </style>
</head>
<body>

  <div id="splash-screen">
    <div class="spinner"></div>
    <div id="splash-text">A carregar e processar dados<span class="loading-dots"></span></div>
  </div>

  <div class="container-lab" id="main-container" style="opacity: 0;">
    
    <div class="control-panel">
      <h4>Laborat√≥rio de Efic√°cia</h4> 
      
      <div class="control-group">
        <button class="secondary" id="btn-voltar" onclick="voltarParaConfiguracao()" style="padding: 10px 15px; font-size: 0.9em; border-width: 1px;">
          &larr; Voltar (Alterar Coorte)
        </button>
        <div id="voltar-loading">A voltar...</div>
      </div>

      <div id="filtros-dinamicos-container">
        </div>
      <div class="control-group">
        <label for="exames-checkbox-group">1. Exames (Desfechos):</label>
        <div id="exames-checkbox-group" class="checkbox-group">
          A carregar...
        </div>
      </div>
      
      <div class="control-group dose-toggle">
        <label for="chk-dose">
          <input type="checkbox" id="chk-dose" onchange="handleDoseToggle()">
          Sobrepor Dose (mg/kg)
        </label>
      </div>

      <div class="control-group">
        <label>2. Filtro de Idade (em Dias):</label>
        <div id="age-slider"></div>
        <div id="age-readout" class="slider-readout">A carregar...</div>
      </div>
      
      <div class="control-group">
        <label for="control-agrupamento">3. Agrupar tempo por:</label>
        <select id="control-agrupamento">
          <option value="semana">Semana</option>
          <option value="dia">Dia</option>
          <option value="mes">M√™s</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="control-tipografico">4. Tipo de Gr√°fico (An√°lise):</label>
        <select id="control-tipografico">
          <option value="media">M√©dia da Coorte</option>
          <option value="individual">Linhas de Pacientes Individuais</option>
          <option value="proporcao">Propor√ß√£o (Desfecho)</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="control-divisaomedia">5. Sub-dividir M√©dia/Propor√ß√£o por:</label>
        <select id="control-divisaomedia">
          <option value="nenhuma">Sem sub-divis√£o</option>
          </select>
      </div>
      
      <div class="control-group">
        <label for="control-bandaerro">6. Banda de Erro (para M√©dia):</label>
        <select id="control-bandaerro">
          <option value="nenhuma">Nenhuma</option>
          <option value="dp" selected>Desvio Padr√£o (¬±DP)</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="control-tipovisual">7. Tipo de Visualiza√ß√£o (M√©dia/Indiv.):</label>
        <select id="control-tipovisual">
          <option value="lines+markers">Linhas + Pontos</option>
          <option value="bar">Barras</option>
          <option value="lines">Apenas Linhas</option>
          <option value="markers">Apenas Pontos (Dispers√£o)</option>
        </select>
      </div>

      <div class="control-group">
        <label for="control-eixoy2">8. Eixo Y Secund√°rio (Opcional):</label>
        <select id="control-eixoy2">
          <option value="nenhum">-- Nenhum --</option>
          </select>
      </div>

      <div class="control-group">
        <h4 style="font-size: 1.1em; margin-bottom: 10px;">Personalizar T√≠tulos (Opcional)</h4>
        <label for="input-titulo">T√≠tulo Principal:</label>
        <input type="text" id="input-titulo" placeholder="Deixar em branco para autom√°tico">
        <label for="input-eixox" style="margin-top: 10px;">T√≠tulo Eixo X:</label>
        <input type="text" id="input-eixox" placeholder="Deixar em branco para autom√°tico">
        <label for="input-eixoy" style="margin-top: 10px;">T√≠tulo Eixo Y (Prim√°rio):</label>
        <input type="text" id="input-eixoy" placeholder="Deixar em branco para autom√°tico">
      </div>
      <div class="control-group t-test-container">
        <h4 style="font-size: 1.1em; margin-bottom: 10px;">An√°lise Estat√≠stica (Teste T)</h4>
        <p style="font-size: 0.8em; color: #666; margin-top: -10px; margin-bottom: 10px;">Compare dois per√≠odos (ex: pr√© vs. p√≥s). Use v√≠rgulas para m√∫ltiplos per√≠odos.</p>
        <label for="input-periodo-antes">Per√≠odos 'Antes' (ex: -2, -1):</label>
        <input type="text" id="input-periodo-antes" value="-2, -1">
        <label for="input-periodo-depois" style="margin-top: 10px;">Per√≠odos 'Depois' (ex: 1, 2):</label>
        <input type="text" id="input-periodo-depois" value="1, 2">
        <button class="secondary" id="btn-testeT" onclick="iniciarTesteT()">üìà Calcular p-value</button>
        <div id="testeT-loading">A calcular...</div>
      </div>
      <br>
      
      <div class="button-row" style="gap: 10px;">
        <button class="action" onclick="desenharGraficoRouter()">üîÑ Atualizar Gr√°fico</button>
        <button class="action-afixar" id="btn-afixar" onclick="abrirModalContexto()" disabled>
          üìå Afixar ao Relat√≥rio
        </button>
      </div>
      <div id="afixar-loading">A afixar...</div>
      <button class="export" id="btn-exportar" onclick="iniciarExportacao()">üì• Exportar Dados</button>
      <div id="export-loading">A exportar...</div>
    </div>
    
    <div class="chart-container">
      <div id="graficoPlotly"></div>
    </div>
  </div>

  <div id="error-container">
    <h3>Falha ao Carregar o Laborat√≥rio</h3>
    <pre id="error-message"></pre>
    <p style="margin-top: 20px;"><b>Como resolver:</b><br>
    Verifique se todas as abas e colunas mapeadas no passo anterior existem e est√£o corretas.</p>
  </div>


  <div class="modal-overlay" id="modal-contexto-overlay">
    <div class="modal-content">
      
      <div class="modal-header">
        <h4>Contextualizar e Afixar Bloco</h4>
      </div>
      
      <div class="modal-body">
        
        <div class="form-group">
          <label for="input-contexto-titulo">T√≠tulo do Gr√°fico:</label>
          <input type="text" id="input-contexto-titulo">
        </div>
        
        <div class_ ="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label for="input-contexto-eixox">T√≠tulo Eixo X:</label>
            <input type="text" id="input-contexto-eixox">
          </div>
          <div>
            <label for="input-contexto-eixoy">T√≠tulo Eixo Y (Prim√°rio):</label>
            <input type="text" id="input-contexto-eixoy">
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>Resultados-Chave (Autom√°tico):</label>
          <div id="contexto-resultados-estatisticos">
            Nenhuma an√°lise estat√≠stica executada.
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label>Anota√ß√£o / Interpreta√ß√£o (Opcional):</label>
          <div id="div-contexto-notas"></div> 
        </div>

      </div>
      
      <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid var(--cor-borda); background-color: #fff; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <button class="secondary" onclick="fecharModalContexto()" style="width: auto; padding: 10px 20px; border-width: 2px;">Cancelar</button>
          
          <div id="loading-modal-salvar" style="display: none; font-size: 0.9em;">A salvar...</div>

          <button class="action" id="btn-salvar-contexto" onclick="salvarContextoECompletarAfixar()" style="width: auto; padding: 12px 28px;">
            Salvar no Gabinete
          </button>
        </div>
      </div>

    </div>
  </div>
  <script>
    // 1. Vari√°veis Globais
    let globalRawData;
    let infoProjeto;
    let globalAgeSlider = null; 
    let minAge = 0; 
    let maxAge = 0; 
    const ONE_DAY_MS_JS = 1000 * 60 * 60 * 24;
    let globalDadosAgregadosParaExportar = [];
    let colunasFiltroDinamico = [];

    // --- MUDAN√áA 5: Novas Vari√°veis Globais ---
    let globalLastChartData = null; // Armazena dados do Plotly
    let globalLastTestResult = null; // Armazena resultados do Teste-T
    let globalQuillContexto = null; // Inst√¢ncia do editor
    const quillContextoOptions = {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ]
      },
      placeholder: 'Escreva a sua principal conclus√£o ou an√°lise aqui...'
    };
    // --- FIM DA MUDAN√áA 5 ---


    window.addEventListener('load', iniciarGrafico);

    function iniciarGrafico() {
      console.log("P√°gina 100% carregada. A pedir dados ao backend...");
      if (typeof Plotly === 'undefined' || typeof noUiSlider === 'undefined' || typeof Quill === 'undefined') {
        mostrarPainelDeErro("Falha ao carregar bibliotecas externas (Plotly, noUiSlider ou Quill).");
        return;
      }
      google.script.run
        .withSuccessHandler(onDadosRecebidos)
        .withFailureHandler(onErroAoReceber)
        .buscarDadosParaGrafico(); // (ANALISE.GS)
    }

    function onErroAoReceber(erro) {
      console.error("Erro fatal de comunica√ß√£o:", erro);
      mostrarPainelDeErro(erro.message);
    }

    function onDadosRecebidos(dadosJsonString) {
      try {
        const dadosInjetados = JSON.parse(dadosJsonString);
        if (!dadosInjetados) {
          throw new Error("O backend retornou 'null'. Verifique os logs do Apps Script.");
        }
        if (dadosInjetados.sucesso === false) {
          throw new Error(dadosInjetados.erro); 
        }
        console.log("Dados recebidos e parseados com sucesso.", dadosInjetados);
        globalRawData = dadosInjetados.rawData;
        infoProjeto = dadosInjetados.info; // Cont√©m 'colunasFiltro'
        colunasFiltroDinamico = dadosInjetados.info.colunasFiltro || [];
        
        setupPainelDeControlo();
        mostrarConteudoPrincipal();
      } catch (e) {
        console.error("Erro ao processar dados:", e.message);
        mostrarPainelDeErro(e.message);
      }
    }
    
    // (Fun√ß√µes de UI e helpers de dados... mostrarPainelDeErro, mostrarConteudoPrincipal, voltarParaConfiguracao, calcularEstatisticas, filtrarDadosGlobais, getNomeCoorte...)
    // (Estas permanecem iguais √† v3.5, n√£o precisam ser coladas de novo)
    function mostrarPainelDeErro(mensagem) {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      const error = document.getElementById('error-container');
      splash.style.opacity = '0';
      setTimeout(() => { splash.style.display = 'none'; }, 500);
      error.style.display = 'block';
      document.getElementById('error-message').textContent = mensagem;
      main.style.display = 'none';
    }
    function mostrarConteudoPrincipal() {
      const splash = document.getElementById('splash-screen');
      const main = document.getElementById('main-container');
      splash.style.opacity = '0';
      setTimeout(function() {
        splash.style.display = 'none'; 
        main.style.opacity = '1';
        document.body.style.backgroundColor = 'var(--cor-fundo-app)'; 
      }, 500);
    }
    function voltarParaConfiguracao() {
      const btn = document.getElementById('btn-voltar');
      const loading = document.getElementById('voltar-loading');
      btn.disabled = true;
      loading.style.display = 'block';
      const splash = document.getElementById('splash-screen');
      document.getElementById('splash-text').innerHTML = 'A voltar para a configura√ß√£o<span class="loading-dots"></span>';
      document.getElementById('main-container').style.opacity = '0';
      splash.style.display = 'flex';
      splash.style.opacity = '1';
      document.body.style.backgroundColor = 'var(--cor-fundo-card)';
      google.script.run
        .withSuccessHandler(function() { google.script.host.close(); })
        .withFailureHandler(function(err) {
          btn.disabled = false;
          loading.style.display = 'none';
          mostrarPainelDeErro("Erro ao voltar: " + err.message);
        })
        .abrirModalAnaliseMedicamento(); 
    }
    function calcularEstatisticas(arr) {
      if (!arr || arr.length === 0) return { media: null, n: 0, stdDev: null };
      const n = arr.length;
      const sum = arr.reduce((a, b) => a + b, 0);
      const media = sum / n;
      if (n === 1) return { media: media, n: 1, stdDev: 0 };
      const variancia = arr.map(x => Math.pow(x - media, 2)).reduce((a, b) => a + b, 0) / (n - 1);
      const stdDev = Math.sqrt(variancia);
      return { media: media, n: n, stdDev: stdDev };
    }
    function filtrarDadosGlobais(forcarExames = false) {
      // 1. Filtro de Exames (checkboxes)
      let examesSelecionados = Array.from(document.querySelectorAll('#exames-checkbox-group input:checked')).map(cb => cb.value);
      if (forcarExames) {
        examesSelecionados = examesSelecionados.filter(ex => ex !== 'dose_interven√ß√£o');
      } else {
        if (document.getElementById('chk-dose').checked) {
          examesSelecionados.push('dose_interven√ß√£o');
        }
      }

      // 2. Filtro de Idade (slider)
      const [idadeMinSelecionada, idadeMaxSelecionada] = globalAgeSlider.get();
      
      // 3. Filtros Din√¢micos (dropdowns)
      const filtrosDinamicosAtivos = {};
      colunasFiltroDinamico.forEach(nomeColuna => {
        const valor = document.getElementById(`filtro-dinamico-${nomeColuna}`).value;
        if (valor !== "todos") {
          filtrosDinamicosAtivos[nomeColuna] = valor;
        }
      });

      return globalRawData.filter(row => {
        // Aplica Filtro de Exame
        if (!examesSelecionados.includes(row.nomeExame)) return false;

        // Aplica Filtro de Idade
        let idadeEmDias = null;
        if (row.dataNascPacienteMs && row.dataExameMs) {
          const idadeMs = row.dataExameMs - row.dataNascPacienteMs;
          idadeEmDias = Math.floor(idadeMs / ONE_DAY_MS_JS);
        }
        if (idadeEmDias !== null && (idadeEmDias < idadeMinSelecionada || idadeEmDias > idadeMaxSelecionada)) {
          return false;
        }
        
        // Aplica Filtros Din√¢micos
        for (const key in filtrosDinamicosAtivos) {
          if (row[key] !== filtrosDinamicosAtivos[key]) {
            return false;
          }
        }
        
        return true;
      });
    }
    function getNomeCoorte(row, subDivisao) {
      if (subDivisao === "nenhuma") {
        return "Total";
      }
      // A 'subDivisao' √© o NOME DA COLUNA (ex: "SEXO")
      return row[subDivisao] || "N/D";
    }
    

    /**
     * Roteador de Gr√°ficos (Atualizado)
     */
    function desenharGraficoRouter() {
      // Limpa os dados antigos
      globalLastChartData = null;
      globalLastTestResult = null;
      document.getElementById('btn-afixar').disabled = true;

      if (!globalRawData) return; 
      const tipoGrafico = document.getElementById('control-tipografico').value;
      globalDadosAgregadosParaExportar = [];
      
      let layout;
      let traces;
      
      if (tipoGrafico === 'proporcao') {
        const { traces: t, layout: l } = desenharGraficoProporcao();
        traces = t;
        layout = l;
      } else {
        const { traces: t, layout: l } = desenharGraficoMediaIndividual();
        traces = t;
        layout = l;
      }
      
      // Salva o gr√°fico gerado
      globalLastChartData = {
        traces: traces,
        layout: layout,
        id: `grafico-temporal-${new Date().getTime()}`
      };
      // Ativa o bot√£o para afixar
      document.getElementById('btn-afixar').disabled = false;
    }

    /**
     * Desenha o gr√°fico de Propor√ß√£o (barras empilhadas)
     */
    function desenharGraficoProporcao() {
      const dadosFiltrados = filtrarDadosGlobais(true); 
      const agrupamento = document.getElementById('control-agrupamento').value;
      const subDivisao = document.getElementById('control-divisaomedia').value; // ex: "SEXO"
      
      const tituloGrafico = document.getElementById('input-titulo').value || `Propor√ß√£o de Desfecho: ${infoProjeto.medicamento}`;
      const tituloX = document.getElementById('input-eixox').value || `Per√≠odo (${agrupamento})`;
      const tituloY = document.getElementById('input-eixoy').value || "Propor√ß√£o de Pacientes (%)";
      
      globalDadosAgregadosParaExportar = [ ["Exame", "Coorte", `Per√≠odo (${agrupamento})`, "Categoria", "Percentagem (%)", "Contagem (N)", "Total (N)"] ];

      const bucketsAgrupados = {};
      dadosFiltrados.forEach(row => {
        let bucketId;
        if (agrupamento === "semana") bucketId = Math.floor(row.diasRelativos / 7);
        else if (agrupamento === "mes") bucketId = Math.floor(row.diasRelativos / 30.44);
        else bucketId = row.diasRelativos;
        
        let coorte = getNomeCoorte(row, subDivisao);
        
        if (!bucketsAgrupados[row.nomeExame]) bucketsAgrupados[row.nomeExame] = {};
        if (!bucketsAgrupados[row.nomeExame][coorte]) bucketsAgrupados[row.nomeExame][coorte] = {};
        if (!bucketsAgrupados[row.nomeExame][coorte][bucketId]) {
          bucketsAgrupados[row.nomeExame][coorte][bucketId] = { Normal: 0, Acima: 0, Abaixo: 0, Outro: 0 };
        }
        
        const analise = row.analise || "Outro";
        if (analise === "Normal") bucketsAgrupados[row.nomeExame][coorte][bucketId].Normal++;
        else if (analise === "Acima") bucketsAgrupados[row.nomeExame][coorte][bucketId].Acima++;
        else if (analise === "Abaixo") bucketsAgrupados[row.nomeExame][coorte][bucketId].Abaixo++;
        else bucketsAgrupados[row.nomeExame][coorte][bucketId].Outro++;
      });

      let globalPlotlyTraces = [];
      const exames = Object.keys(bucketsAgrupados);
      exames.forEach(nomeExame => {
        const dadosDoExame = bucketsAgrupados[nomeExame];
        const coortes = Object.keys(dadosDoExame).sort();
        coortes.forEach(coorte => {
          const bucketsDaCoorte = dadosDoExame[coorte];
          const bucketsOrdenados = Object.keys(bucketsDaCoorte).map(Number).sort((a, b) => a - b);
          const traceNormal = { x: [], y: [], text: [], name: `Normal (${coorte})`, type: 'bar', marker: { color: 'var(--cor-normal)' }, hoverinfo: 'text' };
          const traceAcima = { x: [], y: [], text: [], name: `Acima (${coorte})`, type: 'bar', marker: { color: 'var(--cor-acima)' }, hoverinfo: 'text' };
          const traceAbaixo = { x: [], y: [], text: [], name: `Abaixo (${coorte})`, type: 'bar', marker: { color: 'var(--cor-abaixo)' }, hoverinfo: 'text' };
          bucketsOrdenados.forEach(bucketId => {
            const dadosBucket = bucketsDaCoorte[bucketId];
            const total = dadosBucket.Normal + dadosBucket.Acima + dadosBucket.Abaixo;
            if (total === 0) {
              traceNormal.x.push(bucketId); traceNormal.y.push(0); traceNormal.text.push(null);
              traceAcima.x.push(bucketId); traceAcima.y.push(0); traceAcima.text.push(null);
              traceAbaixo.x.push(bucketId); traceAbaixo.y.push(0); traceAbaixo.text.push(null);
              return;
            }
            const percNormal = (dadosBucket.Normal / total) * 100;
            const percAcima = (dadosBucket.Acima / total) * 100;
            const percAbaixo = (dadosBucket.Abaixo / total) * 100;
            traceNormal.x.push(bucketId); traceNormal.y.push(percNormal);
            traceAcima.x.push(bucketId); traceAcima.y.push(percAcima);
            traceAbaixo.x.push(bucketId); traceAbaixo.y.push(percAbaixo);
            const textoHover = `<b>${nomeExame} (${coorte})<br>Per√≠odo ${bucketId}</b><br>Normal: ${percNormal.toFixed(1)}% (${dadosBucket.Normal} de ${total})<br>Acima: ${percAcima.toFixed(1)}% (${dadosBucket.Acima} de ${total})<br>Abaixo: ${percAbaixo.toFixed(1)}% (${dadosBucket.Abaixo} de ${total})`;
            traceNormal.text.push(textoHover);
            traceAcima.text.push(textoHover);
            traceAbaixo.text.push(textoHover);
            globalDadosAgregadosParaExportar.push([nomeExame, coorte, bucketId, "Abaixo", percAbaixo.toFixed(2), dadosBucket.Abaixo, total]);
            globalDadosAgregadosParaExportar.push([nomeExame, coorte, bucketId, "Normal", percNormal.toFixed(2), dadosBucket.Normal, total]);
            globalDadosAgregadosParaExportar.push([nomeExame, coorte, bucketId, "Acima", percAcima.toFixed(2), dadosBucket.Acima, total]);
          });
          globalPlotlyTraces.push(traceAbaixo, traceNormal, traceAcima);
        });
      });
      let globalPlotlyLayout = {
        title: { text: tituloGrafico, y: 0.95, x: 0.5, xanchor: 'center', yanchor: 'top' },
        xaxis: { title: tituloX },
        yaxis: { title: tituloY, range: [0, 100] },
        barmode: 'stack', hovermode: 'closest',
        legend: { orientation: "h", y: -0.2, yanchor: "top", x: 0.5, xanchor: 'center' },
        margin: { t: 80, b: 100 }, 
        annotations: [{ x: 0, y: 0.95, xref: 'x', yref: 'paper', text: 'Dia 0 = In√≠cio da Interven√ß√£o', showarrow: true, arrowhead: 4, ax: 0, ay: -40, font: { color: 'var(--cor-vermelho-intervencao)', size: 12, style: 'italic' }, bordercolor: '#c7c7c7', borderwidth: 1, bgcolor: 'rgba(255,255,255,0.8)' }]
      };
      Plotly.newPlot('graficoPlotly', globalPlotlyTraces, globalPlotlyLayout);
      return { traces: globalPlotlyTraces, layout: globalPlotlyLayout };
    }


    /**
     * Desenha os gr√°ficos de M√©dia e Individual
     */
    function desenharGraficoMediaIndividual() {
      let addedRefLegend = false;
      const dadosFiltrados = filtrarDadosGlobais(false); 
      const agrupamento = document.getElementById('control-agrupamento').value;
      const tipoGrafico = document.getElementById('control-tipografico').value;
      const subDivisao = document.getElementById('control-divisaomedia').value; 
      const bandaErro = document.getElementById('control-bandaerro').value;
      const tipoVisual = document.getElementById('control-tipovisual').value;
      const exameY2 = document.getElementById('control-eixoy2').value;
      const tituloGrafico = document.getElementById('input-titulo').value || `Tend√™ncia: ${infoProjeto.medicamento}`;
      const tituloX = document.getElementById('input-eixox').value || `Per√≠odo (${agrupamento})`;
      const tituloY = document.getElementById('input-eixoy').value || "Valor Eixo Prim√°rio (Y1)";

      if (tipoGrafico === 'individual') {
          globalDadosAgregadosParaExportar = [ ["Exame", "Coorte", "Paciente (Prontu√°rio)", `Per√≠odo (${agrupamento})`, "Valor", "Ref. M√≠n", "Ref. M√°x"] ];
      } else {
          globalDadosAgregadosParaExportar = [ ["Exame", "Coorte", `Per√≠odo (${agrupamento})`, "Valor (M√©dia)", "Desvio Padr√£o (DP)", "Contagem (N)"] ];
      }

      const bucketsAgrupados = {};
      dadosFiltrados.forEach(row => {
        let bucketId;
        if (agrupamento === "semana") bucketId = Math.floor(row.diasRelativos / 7);
        else if (agrupamento === "mes") bucketId = Math.floor(row.diasRelativos / 30.44);
        else bucketId = row.diasRelativos;
        
        let coorte;
        if (tipoGrafico === 'individual') {
          coorte = `${row.prontuario}`; // Simplificado para apenas prontu√°rio
        } else {
          coorte = getNomeCoorte(row, subDivisao);
        }
        
        if (!bucketsAgrupados[row.nomeExame]) bucketsAgrupados[row.nomeExame] = {};
        if (!bucketsAgrupados[row.nomeExame][coorte]) bucketsAgrupados[row.nomeExame][coorte] = {};
        if (!bucketsAgrupados[row.nomeExame][coorte][bucketId]) bucketsAgrupados[row.nomeExame][coorte][bucketId] = [];
        bucketsAgrupados[row.nomeExame][coorte][bucketId].push(row);
      });

      let globalPlotlyTraces = [];
      const exames = Object.keys(bucketsAgrupados);
      exames.forEach(nomeExame => {
        const dadosDoExame = bucketsAgrupados[nomeExame];
        const coortes = Object.keys(dadosDoExame).sort();
        const todosBuckets = new Set();
        Object.values(dadosDoExame).forEach(grupo => {
          Object.keys(grupo).forEach(bucketId => todosBuckets.add(Number(bucketId)));
        });
        const bucketsOrdenados = Array.from(todosBuckets).sort((a, b) => a - b);
        coortes.forEach(coorte => {
          const nomeTrace = (nomeExame === 'dose_interven√ß√£o') ? "Dose (mg/kg)" : (nomeExame.charAt(0).toUpperCase() + nomeExame.slice(1));
          const eixoY = (nomeExame === exameY2) ? 'y2' : 'y1'; 
          if (tipoGrafico === 'individual') {
            const traceValor = { x: [], y: [], text: [], type: (tipoVisual === 'bar') ? 'bar' : 'scatter', mode: (tipoVisual === 'bar') ? null : tipoVisual, name: `${nomeTrace} (${coorte})`, hoverinfo: 'text', yaxis: eixoY };
            const traceMin = { x: [], y: [], mode: 'lines', name: `Ref. M√≠n (${coorte})`, line: { color: 'grey', dash: 'dash' }, showlegend: false, hoverinfo: 'none', yaxis: eixoY };
            const traceMax = { x: [], y: [], mode: 'lines', name: 'Faixa de Refer√™ncia', line: { color: 'grey', dash: 'dash' }, fill: 'tonexty', fillcolor: 'rgba(0,150,0,0.1)', hoverinfo: 'none', yaxis: eixoY, showlegend: !addedRefLegend && nomeExame !== 'dose_interven√ß√£o' };
            bucketsOrdenados.forEach(bucketId => {
              traceValor.x.push(bucketId);
              traceMin.x.push(bucketId);
              traceMax.x.push(bucketId);
              if (dadosDoExame[coorte][bucketId]) {
                const dadosDoPonto = dadosDoExame[coorte][bucketId][0]; 
                const dataExameFormatada = new Date(dadosDoPonto.dataExameMs).toLocaleDateString('pt-BR');
                traceValor.y.push(dadosDoPonto.valor);
                traceValor.text.push(`<b>${coorte}</b><br>Data: ${dataExameFormatada}<br>Valor: ${dadosDoPonto.valor}<br>Ref: ${dadosDoPonto.refMin}-${dadosDoPonto.refMax}`);
                const nomeCoorteExport = getNomeCoorte(dadosDoPonto, subDivisao);
                globalDadosAgregadosParaExportar.push([nomeExame, nomeCoorteExport, coorte, bucketId, dadosDoPonto.valor, dadosDoPonto.refMin, dadosDoPonto.refMax]);
                if (nomeExame !== 'dose_interven√ß√£o') {
                  traceMin.y.push(dadosDoPonto.refMin);
                  traceMax.y.push(dadosDoPonto.refMax);
                } else {
                  traceMin.y.push(null); traceMax.y.push(null);
                }
              } else {
                traceValor.y.push(null); traceMin.y.push(null); traceMax.y.push(null); traceValor.text.push(null);
              }
            });
            if (nomeExame !== 'dose_interven√ß√£o') {
              globalPlotlyTraces.push(traceMin, traceMax);
              if (!addedRefLegend) addedRefLegend = true; 
            }
            globalPlotlyTraces.push(traceValor);
          } else {
            const traceMedia = { x: [], y: [], text: [], type: (tipoVisual === 'bar') ? 'bar' : 'scatter', mode: (tipoVisual === 'bar') ? null : tipoVisual, name: `${nomeTrace} (${coorte})`, hoverinfo: 'text', yaxis: eixoY };
            const traceUpper = { x: [], y: [], mode: 'lines', name: `Banda Sup. (${coorte})`, line: { width: 0 }, showlegend: false, hoverinfo: 'none', yaxis: eixoY };
            const traceLower = { x: [], y: [], mode: 'lines', name: `Banda Inf. (${coorte})`, line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(0,100,80,0.2)', showlegend: false, hoverinfo: 'none', yaxis: eixoY };
            bucketsOrdenados.forEach(bucketId => {
              traceMedia.x.push(bucketId);
              traceUpper.x.push(bucketId);
              traceLower.x.push(bucketId);
              if (dadosDoExame[coorte][bucketId]) {
                const valoresDoBucket = dadosDoExame[coorte][bucketId].map(d => d.valor);
                const stats = calcularEstatisticas(valoresDoBucket);
                traceMedia.y.push(stats.media);
                if (bandaErro === 'dp' && stats.stdDev !== null && stats.stdDev > 0) {
                  traceUpper.y.push(stats.media + stats.stdDev);
                  traceLower.y.push(stats.media - stats.stdDev);
                } else {
                  traceUpper.y.push(stats.media);
                  traceLower.y.push(stats.media);
                }
                traceMedia.text.push(`<b>${traceMedia.name}</b><br>Per√≠odo: ${bucketId}<br>M√©dia: ${stats.media.toFixed(2)}<br>DP: ¬±${(stats.stdDev || 0).toFixed(2)}<br>n = ${stats.n}`);
                globalDadosAgregadosParaExportar.push([nomeExame, coorte, bucketId, stats.media.toFixed(2), (stats.stdDev || 0).toFixed(2), stats.n]);
              } else {
                traceMedia.y.push(null); traceUpper.y.push(null); traceLower.y.push(null); traceMedia.text.push(null);
              }
            });
            if (bandaErro !== 'nenhuma' && nomeExame !== 'dose_interven√ß√£o') globalPlotlyTraces.push(traceLower, traceUpper);
            globalPlotlyTraces.push(traceMedia);
          }
        });
      });
      const nomeEixoY2 = (exameY2 === 'dose_interven√ß√£o') ? "Dose (mg/kg)" : (exameY2 === 'nenhum' ? '' : exameY2);
      let globalPlotlyLayout = {
        title: { text: tituloGrafico, y: 0.95, x: 0.5, xanchor: 'center', yanchor: 'top' },
        xaxis: { title: tituloX, domain: [0, (exameY2 !== 'nenhum' ? 0.95 : 1.0)] },
        yaxis: { title: tituloY }, 
        yaxis2: { title: nomeEixoY2, overlaying: 'y', side: 'right', showgrid: false, visible: (exameY2 !== 'nenhum') },
        hovermode: 'closest',
        legend: { orientation: "h", y: -0.2, yanchor: "top", x: 0.5, xanchor: 'center' },
        margin: { t: 80, b: 100 }, 
        annotations: [{ x: 0, y: 0.95, xref: 'x', yref: 'paper', text: 'Dia 0 = In√≠cio da Interven√ß√£o', showarrow: true, arrowhead: 4, ax: 0, ay: -40, font: { color: 'var(--cor-vermelho-intervencao)', size: 12, style: 'italic' }, bordercolor: '#c7c7c7', borderwidth: 1, bgcolor: 'rgba(255,255,255,0.8)' }]
      };
      Plotly.newPlot('graficoPlotly', globalPlotlyTraces, globalPlotlyLayout);
      return { traces: globalPlotlyTraces, layout: globalPlotlyLayout };
    }
    
    /**
     * Fun√ß√£o de Setup
     */
    function setupPainelDeControlo() {
      if (!globalRawData) return; 

      // 1. Popula Filtros Din√¢micos
      const filtroContainer = document.getElementById('filtros-dinamicos-container');
      const subdivisaoSelect = document.getElementById('control-divisaomedia');
      filtroContainer.innerHTML = '';
      subdivisaoSelect.innerHTML = '<option value="nenhuma">Sem sub-divis√£o</option>';

      colunasFiltroDinamico.forEach(nomeColuna => {
        const valoresUnicos = [...new Set(globalRawData.map(row => row[nomeColuna]))].sort();
        
        subdivisaoSelect.innerHTML += `<option value="${nomeColuna}">${nomeColuna}</option>`;
        
        let filtroHtml = `
          <div class="filtro-dinamico-group">
            <label for="filtro-dinamico-${nomeColuna}">Filtrar por ${nomeColuna}:</label>
            <select id="filtro-dinamico-${nomeColuna}">
              <option value="todos">Todos</option>
              ${valoresUnicos.map(v => `<option value="${v}">${v}</option>`).join('')}
            </select>
          </div>
        `;
        filtroContainer.innerHTML += filtroHtml;
      });

      // 2. Preenche os Checkboxes de Exames
      const examesContainer = document.getElementById('exames-checkbox-group');
      const y2Select = document.getElementById('control-eixoy2'); 
      const examesUnicos = [...new Set(globalRawData.map(row => row.nomeExame))]
                            .filter(exame => exame !== 'dose_interven√ß√£o');
      examesContainer.innerHTML = ''; 
      examesUnicos.sort().forEach((exame, index) => {
        const nomeBonito = exame.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const isChecked = (index === 0) ? "checked" : ""; 
        examesContainer.innerHTML += `
          <label><input type="checkbox" name="exame" value="${exame}" ${isChecked} onchange="atualizarDropdownY2()"> ${nomeBonito}</label>
        `;
      });
      atualizarDropdownY2(); 

      if (!globalRawData.some(row => row.nomeExame === 'dose_interven√ß√£o')) {
         document.getElementById('chk-dose').closest('.control-group').style.display = 'none';
      }

      // 3. Configura o Slider de Idade
      const readout = document.getElementById('age-readout');
      const slider = document.getElementById('age-slider');
      const idades = globalRawData
        .map(row => {
          if (!row.dataNascPacienteMs || !row.dataExameMs) return null;
          const idadeMs = row.dataExameMs - row.dataNascPacienteMs;
          return Math.floor(idadeMs / ONE_DAY_MS_JS);
        })
        .filter(idade => idade !== null && !isNaN(idade));
      if (idades.length > 0) {
        minAge = Math.min(...idades);
        maxAge = Math.max(...idades);
        if (minAge === maxAge) maxAge += 1; 
      } else {
        minAge = 0; maxAge = 100;
      }
      globalAgeSlider = noUiSlider.create(slider, {
          start: [minAge, maxAge], connect: true, step: 1,
          range: { 'min': minAge, 'max': maxAge },
          tooltips: [true, true], 
          format: { to: value => Math.round(value), from: value => Number(value) }
      });
      slider.noUiSlider.on('update', function (values) {
          readout.innerHTML = `Faixa de idade (dias): <strong>${values[0]}</strong> - <strong>${values[1]}</strong>`;
      });
      
      // 4. Desenha o gr√°fico pela primeira vez
      desenharGraficoRouter();
    }
    
    // (O restante do JS - handleDoseToggle, atualizarDropdownY2, Exporta√ß√£o - permanece o mesmo)
    
    function handleDoseToggle() {
      atualizarDropdownY2();
    }
    function atualizarDropdownY2() {
      try {
        const y2Select = document.getElementById('control-eixoy2');
        let examesSelecionados = Array.from(document.querySelectorAll('#exames-checkbox-group input:checked'));
        if (document.getElementById('chk-dose').checked) {
          examesSelecionados.push({ value: 'dose_interven√ß√£o' });
        }
        const valorAntigo = y2Select.value;
        y2Select.innerHTML = '<option value="nenhum">-- Nenhum --</option>'; 
        examesSelecionados.forEach(checkbox => {
          const exame = checkbox.value; 
          const nomeBonito = exame.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          y2Select.innerHTML += `<option value="${exame}">${nomeBonito}</option>`;
        });
        if (Array.from(y2Select.options).some(opt => opt.value === valorAntigo)) {
          y2Select.value = valorAntigo;
        }
      } catch(e) {
        console.warn("Erro ao atualizar dropdown Y2 (ignorado): " + e.message);
      }
    }
    function iniciarExportacao() {
      if (!globalDadosAgregadosParaExportar || globalDadosAgregadosParaExportar.length <= 1) {
        alert("Por favor, clique em 'üîÑ Atualizar Gr√°fico' primeiro para gerar os dados a exportar.");
        return;
      }
      const btn = document.getElementById('btn-exportar');
      const loading = document.getElementById('export-loading');
      btn.disabled = true;
      btn.textContent = "A exportar...";
      loading.style.display = 'block';
      google.script.run
        .withSuccessHandler(onExportacaoSucesso)
        .withFailureHandler(onExportacaoErro)
        .exportarDadosParaPlanilha(globalDadosAgregadosParaExportar);
    }
    function onExportacaoSucesso(resultado) {
      const btn = document.getElementById('btn-exportar');
      const loading = document.getElementById('export-loading');
      btn.disabled = false;
      loading.style.display = 'none';
      btn.textContent = "Exportado! ‚úÖ";
      setTimeout(() => {
          btn.textContent = "üì• Exportar Dados";
      }, 2500);
    }
    function onExportacaoErro(erro) {
      const btn = document.getElementById('btn-exportar');
      const loading = document.getElementById('export-loading');
      btn.disabled = false;
      loading.style.display = 'none';
      btn.textContent = "üì• Exportar Dados";
      alert("Falha na exporta√ß√£o: " + erro.message);
    }
    function parsePeriodos(inputString) {
      return inputString.split(',')
                        .map(s => s.trim())
                        .filter(s => s !== "")
                        .map(s => Number(s))
                        .filter(n => !isNaN(n));
    }
    

    /**
     * --- MUDAN√áA 6: Fun√ß√µes do Teste-T atualizadas ---
     */
    function iniciarTesteT() {
      const btn = document.getElementById('btn-testeT');
      const loading = document.getElementById('testeT-loading');
      btn.disabled = true;
      loading.style.display = 'block';
      globalLastTestResult = null; // Limpa o resultado anterior
      
      try {
        const examesSelecionados = Array.from(document.querySelectorAll('#exames-checkbox-group input:checked'));
        if (examesSelecionados.length !== 1) {
          throw new Error("Por favor, selecione exatamente UM exame (ex: 'F√≥sforo') para comparar.");
        }
        const nomeExame = examesSelecionados[0].value;
        const tipoGrafico = document.getElementById('control-tipografico').value;
        if (tipoGrafico === 'proporcao') {
          throw new Error("O Teste T n√£o se aplica ao gr√°fico de 'Propor√ß√£o'.");
        }
        const periodosAntes = parsePeriodos(document.getElementById('input-periodo-antes').value);
        const periodosDepois = parsePeriodos(document.getElementById('input-periodo-depois').value);
        if (periodosAntes.length === 0 || periodosDepois.length === 0) {
          throw new Error("Per√≠odos 'Antes' e 'Depois' inv√°lidos. Use n√∫meros separados por v√≠rgula (ex: -2, -1).");
        }
        const dadosFiltrados = filtrarDadosGlobais(true);
        const agrupamento = document.getElementById('control-agrupamento').value;
        const subDivisao = document.getElementById('control-divisaomedia').value;
        const gruposDeTeste = {}; 
        dadosFiltrados.forEach(row => {
          if (row.nomeExame !== nomeExame) return;
          let bucketId;
          if (agrupamento === "semana") bucketId = Math.floor(row.diasRelativos / 7);
          else if (agrupamento === "mes") bucketId = Math.floor(row.diasRelativos / 30.44);
          else bucketId = row.diasRelativos;
          const nomeCoorte = getNomeCoorte(row, subDivisao);
          if (!gruposDeTeste[nomeCoorte]) {
            gruposDeTeste[nomeCoorte] = { antes: [], depois: [] };
          }
          if (periodosAntes.includes(bucketId)) {
            gruposDeTeste[nomeCoorte].antes.push(row.valor);
          } else if (periodosDepois.includes(bucketId)) {
            gruposDeTeste[nomeCoorte].depois.push(row.valor);
          }
        });
        const arraysParaTestar = [];
        Object.keys(gruposDeTeste).forEach(nomeCoorte => {
          const dadosCoorte = gruposDeTeste[nomeCoorte];
          if (dadosCoorte.antes.length < 2 || dadosCoorte.depois.length < 2) {
            console.warn(`Coorte '${nomeCoorte}' pulada do Teste T (n < 2).`);
          } else {
            arraysParaTestar.push({
              nome: nomeCoorte,
              antes: dadosCoorte.antes,
              depois: dadosCoorte.depois
            });
          }
        });
        if (arraysParaTestar.length === 0) {
          throw new Error(`Dados insuficientes para o c√°lculo em todas as coortes.\nPer√≠odo 'Antes' (n=${periodosAntes.length})\nPer√≠odo 'Depois' (n=${periodosDepois.length})\n\n√â necess√°rio n >= 2 para cada grupo.`);
        }
        console.log(`Iniciando Teste T para ${arraysParaTestar.length} coorte(s)...`);
        google.script.run
          .withSuccessHandler(onTesteTSucesso)
          .withFailureHandler(onTesteTErro)
          .executarTesteTMultiCoorte(arraysParaTestar); // (de ANALISE.GS)
      } catch (e) {
        onTesteTErro(e); 
      }
    }
    
    function onTesteTSucesso(resultados) {
      const btn = document.getElementById('btn-testeT');
      const loading = document.getElementById('testeT-loading');
      btn.disabled = false;
      loading.style.display = 'none';
      
      let mensagem = "--- Resultado do Teste T ---\n\n";
      resultados.forEach(resultado => {
        if (resultado.erro) {
          mensagem += `Coorte: ${resultado.nome}\nERRO: ${resultado.erro}\n\n`;
        } else {
          mensagem += `Coorte: ${resultado.nome}\n` +
                      `Interpreta√ß√£o: ${resultado.interpretacao} (p = ${resultado.p.toPrecision(4)})\n` +
                      `M√©dia 'Antes': ${resultado.mediaAntes.toFixed(2)} (n=${resultado.nAntes})\n` +
                      `M√©dia 'Depois': ${resultado.mediaDepois.toFixed(2)} (n=${resultado.nDepois})\n\n`;
        }
      });
      
      // Salva o texto do resultado para o modal
      globalLastTestResult = mensagem; 
      alert(mensagem); // Continua a mostrar o alert para feedback imediato
    }
    
    function onTesteTErro(erro) {
      const btn = document.getElementById('btn-testeT');
      const loading = document.getElementById('testeT-loading');
      btn.disabled = false;
      loading.style.display = 'none';
      globalLastTestResult = `Falha no Teste T: ${erro.message}`; // Salva o erro
      alert("Falha no Teste T: " + erro.message);
    }
    
    
    // --- MUDAN√áA 7: Fun√ß√µes do Modal de Contexto (adaptadas) ---
    
    function abrirModalContexto() {
      if (!globalLastChartData) {
        alert("Erro: N√£o h√° dados de gr√°fico para afixar.");
        return;
      }
      
      const layout = globalLastChartData.layout;
      
      // 1. Preencher os campos de texto com os dados atuais do gr√°fico
      document.getElementById('input-contexto-titulo').value = layout.title.text || layout.title || "";
      
      if (layout.xaxis) {
        document.getElementById('input-contexto-eixox').value = layout.xaxis.title || "";
        document.getElementById('input-contexto-eixox').disabled = false;
      } else {
        document.getElementById('input-contexto-eixox').value = "N/A (Gr√°fico de Pizza)";
        document.getElementById('input-contexto-eixox').disabled = true;
      }
      
      if (layout.yaxis) {
        document.getElementById('input-contexto-eixoy').value = layout.yaxis.title || "";
        document.getElementById('input-contexto-eixoy').disabled = false;
      } else {
        document.getElementById('input-contexto-eixoy').value = "N/A (Gr√°fico de Pizza)";
        document.getElementById('input-contexto-eixoy').disabled = true;
      }

      // 2. (NOVO) Preencher a caixa de resultados estat√≠sticos
      const resultadosDiv = document.getElementById('contexto-resultados-estatisticos');
      if (globalLastTestResult) {
        resultadosDiv.textContent = globalLastTestResult;
      } else {
        resultadosDiv.textContent = "Nenhuma an√°lise estat√≠stica executada para este gr√°fico.";
      }

      // 3. Inicializar o editor Quill
      if (!globalQuillContexto) {
        globalQuillContexto = new Quill('#div-contexto-notas', quillContextoOptions);
      }
      globalQuillContexto.setContents([]); // Limpa o editor
      
      // 4. Mostrar o modal
      document.getElementById('modal-contexto-overlay').style.display = 'flex';
    }
    
    function fecharModalContexto() {
      document.getElementById('modal-contexto-overlay').style.display = 'none';
      if (globalQuillContexto) {
        globalQuillContexto.setContents([]);
      }
      document.getElementById('loading-modal-salvar').style.display = 'none';
      document.getElementById('btn-salvar-contexto').disabled = false;
    }

    function salvarContextoECompletarAfixar() {
      if (!globalLastChartData) return;

      const btnSalvar = document.getElementById('btn-salvar-contexto');
      const loadingSalvar = document.getElementById('loading-modal-salvar');
      
      btnSalvar.disabled = true;
      loadingSalvar.style.display = 'block';

      // 1. Ler os novos t√≠tulos
      const novoTitulo = document.getElementById('input-contexto-titulo').value;
      const novoEixoX = document.getElementById('input-contexto-eixox').value;
      const novoEixoY = document.getElementById('input-contexto-eixoy').value;
      
      // 2. Ler as notas do Quill e os resultados estat√≠sticos
      const notasHtml = globalQuillContexto.root.innerHTML;
      const resultadosTexto = document.getElementById('contexto-resultados-estatisticos').textContent;
      
      // 3. Combina as notas e os resultados
      // (Vamos adicionar os resultados estat√≠sticos no topo das notas)
      const notasCompletas = `
        <h3>Resultados-Chave</h3>
        <p><code>${resultadosTexto.replace(/\n/g, '<br>')}</code></p>
        <hr>
        <h3>Interpreta√ß√£o</h3>
        ${notasHtml}
      `;

      // 4. Modificar o objeto de gr√°fico que vamos salvar
      globalLastChartData.layout.title = novoTitulo;
      if (globalLastChartData.layout.xaxis) {
        globalLastChartData.layout.xaxis.title = novoEixoX;
      }
      if (globalLastChartData.layout.yaxis) {
        globalLastChartData.layout.yaxis.title = novoEixoY;
      }

      // 5. Criar o "Bloco de Relat√≥rio" final
      const blocoParaSalvar = {
        tipo: "grafico",
        id: globalLastChartData.id,
        dadosGrafico: globalLastChartData, 
        notas: notasCompletas // Salva as notas E os resultados
      };

      // 6. Enviar o Bloco completo para o backend
      google.script.run
        .withSuccessHandler(onAfixarSucesso)
        .withFailureHandler(onAfixarErro)
        .afixarGraficoDoLabTemporal(JSON.stringify(blocoParaSalvar)); // (ANALISE.GS)
    }


    function onAfixarSucesso(mensagem) {
      fecharModalContexto();
      const btnAfixar = document.getElementById('btn-afixar');
      btnAfixar.textContent = '‚úÖ Afixado!';
      btnAfixar.disabled = true; 
    }

    function onAfixarErro(erro) {
      const loadingSalvar = document.getElementById('loading-modal-salvar');
      loadingSalvar.style.display = 'block';
      loadingSalvar.textContent = `Erro: ${erro.message}`;
      document.getElementById('btn-salvar-contexto').disabled = false;
    }
    // --- FIM DA MUDAN√áA 7 ---

  </script>
</body>
</html>
